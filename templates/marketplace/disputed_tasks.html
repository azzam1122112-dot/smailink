{% extends "base.html" %}
{% block title %}Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø²Ø§Ø¹{% endblock %}

{% block content %}
<section class="py-10 max-w-6xl mx-auto rtl" dir="rtl">

  {# ===== Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ===== #}
  <div class="mb-6 flex items-center justify-between gap-3">
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø²Ø§Ø¹</h1>
    <div class="text-slate-500 dark:text-slate-400 text-sm">{% now "Y-m-d H:i" %}</div>
  </div>

  {% if requests %}
    <div class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
      {% for r in requests %}
        <article class="group relative bg-white/80 dark:bg-slate-800/70 backdrop-blur border border-slate-200 dark:border-slate-700 rounded-2xl p-5 shadow-glass-lg hover:shadow-xl transition-all duration-300">

          {# Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ #}
          <div class="absolute top-0 right-0 h-full w-1 rounded-l-lg bg-rose-500"></div>

          <div class="flex flex-col h-full justify-between">
            <div>
              <div class="flex items-start justify-between gap-3 mb-2">
                <h2 class="text-lg font-extrabold text-slate-900 dark:text-white leading-6 line-clamp-2">
                  {{ r.title|default:"Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†" }}
                </h2>
                <span class="px-2 py-1 text-xs rounded-xl border bg-rose-50 text-rose-700 dark:bg-rose-900/20 dark:text-rose-200 shrink-0">
                  {{ r.get_status_display|default:r.status|default:"Ù†Ø²Ø§Ø¹" }}
                </span>
              </div>

              {# Ø§Ù„Ø¹Ù…ÙŠÙ„ #}
              <p class="text-slate-700 dark:text-slate-200 text-sm">
                <span class="font-semibold text-slate-900 dark:text-white">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span>
                {% if r.client %}
                  {{ r.client.name|default:r.client.email|default:"â€”" }}
                {% else %}
                  â€”
                {% endif %}
              </p>
              {% if r.client and r.client.phone %}
                <p class="text-slate-500 dark:text-slate-400 text-xs" dir="ltr">{{ r.client.phone }}</p>
              {% endif %}

              {# Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ù†Ø¯ Ø¥Ù† ÙˆÙØ¬Ø¯ #}
              <p class="mt-1 text-slate-600 dark:text-slate-300 text-sm">
                <span class="font-semibold">Ø§Ù„Ù…ÙˆØ¸Ù:</span>
                {% if r.assigned_employee %}
                  {{ r.assigned_employee }}
                {% elif r.selected_offer %}
                  {{ r.selected_offer.employee }}
                {% else %}
                  â€”
                {% endif %}
              </p>

              {# Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© #}
              <div class="mt-3 flex flex-wrap items-center gap-2 text-[13px]">
                <span class="px-2 py-1 rounded-lg border bg-white/70 dark:bg-slate-900/50 text-slate-700 dark:text-slate-300">#{{ r.pk }}</span>
                <span class="px-2 py-1 rounded-lg border bg-slate-100 text-slate-700 dark:bg-slate-700/40 dark:text-slate-200">Ù…Ø¬Ù…Ù‘Ø¯</span>
                {% if r.created_at %}
                  <span class="px-2 py-1 rounded-lg border bg-slate-50 text-slate-600 dark:bg-slate-900/40 dark:text-slate-300">Ø£Ù†Ø´Ø¦: {{ r.created_at|date:"Y-m-d H:i" }}</span>
                {% endif %}
                {% if r.updated_at %}
                  <span class="px-2 py-1 rounded-lg border bg-slate-50 text-slate-600 dark:bg-slate-900/40 dark:text-slate-300">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ r.updated_at|date:"Y-m-d H:i" }}</span>
                {% endif %}
              </div>

              {# Ù„Ù…Ø­Ø© Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ #}
              {% if r.details %}
                <div class="mt-3 text-slate-600 dark:text-slate-300 text-sm whitespace-pre-line line-clamp-3">
                  {{ r.details|urlize }}
                </div>
              {% endif %}

              {# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø²Ø§Ø¹ Ø¥Ù† ØªÙˆÙØ±Øª #}
              {% if r.dispute %}
                <div class="mt-3 rounded-lg border border-rose-200 dark:border-rose-900 bg-rose-50 dark:bg-rose-900/20 p-3">
                  {% if r.dispute.title %}
                    <div class="text-sm font-semibold text-rose-700 dark:text-rose-200">{{ r.dispute.title }}</div>
                  {% endif %}
                  {% if r.dispute.reason %}
                    <div class="mt-1 text-sm text-rose-700/90 dark:text-rose-200/90 whitespace-pre-line">{{ r.dispute.reason }}</div>
                  {% endif %}
                  {% if r.dispute.created_at %}
                    <div class="mt-1 text-xs text-rose-600 dark:text-rose-300">ØªØ§Ø±ÙŠØ® ÙØªØ­ Ø§Ù„Ù†Ø²Ø§Ø¹: {{ r.dispute.created_at|date:"Y-m-d H:i" }}</div>
                  {% endif %}
                </div>
              {% endif %}
            </div>

            {# Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª #}
            <div class="mt-4 grid grid-cols-1 gap-2">
              {% if r.short_code %}
                <a href="{% url 'marketplace:request_detail_short' r.short_code %}"
                   class="inline-flex items-center justify-center w-full px-4 py-2 rounded-xl bg-gradient-to-l from-rose-600 to-amber-600 text-white text-sm font-semibold hover:from-rose-700 hover:to-amber-700 transition">
                  Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </a>
              {% else %}
                <a href="{% url 'marketplace:request_detail' r.pk %}"
                   class="inline-flex items-center justify-center w-full px-4 py-2 rounded-xl bg-gradient-to-l from-rose-600 to-amber-600 text-white text-sm font-semibold hover:from-rose-700 hover:to-amber-700 transition">
                  Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </a>
              {% endif %}

              {# Ø²Ø± ÙØªØ­ Ø§Ù„Ù†Ø²Ø§Ø¹ Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ø§Ø¯Ø© Ø¯Ø§Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø› Ù‡Ù†Ø§ Ù†Ø¸Ù‡Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ø²Ø§Ø¹ Ø¥Ù† ÙˆÙØ¬Ø¯ #}
              {% if r.dispute %}
                <a href="{% url 'disputes:detail' r.dispute.pk %}"
                   class="inline-flex items-center justify-center w-full px-4 py-2 rounded-xl border border-rose-300 text-rose-700 dark:text-rose-300 bg-white dark:bg-slate-900 hover:bg-rose-50 dark:hover:bg-rose-900/20">
                  ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø²Ø§Ø¹
                </a>
              {% endif %}
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    {# ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª Ø¥Ù† ÙƒØ§Ù† queryset Ù…ÙØ¬Ø²Ù‘Ø£ #}
    {% if is_paginated %}
      <div class="flex justify-center gap-2 mt-6">
        {% if page_obj.has_previous %}
          <a class="px-3 py-1 rounded-lg border bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800" href="?page={{ page_obj.previous_page_number }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        {% endif %}
        <span class="px-3 py-1 rounded-lg border bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="px-3 py-1 rounded-lg border bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800" href="?page={{ page_obj.next_page_number }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
        {% endif %}
      </div>
    {% endif %}

  {% else %}
    <div class="text-center py-16 bg-white/60 dark:bg-slate-800/60 backdrop-blur border border-dashed border-slate-300 dark:border-slate-600 rounded-2xl">
      <div class="text-6xl mb-3 opacity-40" aria-hidden="true">ğŸ›‘</div>
      <p class="text-lg text-slate-600 dark:text-slate-300 font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø²Ø§Ø¹ Ø­Ø§Ù„ÙŠÙ‹Ø§</p>
      <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙ†Ø§Ø²Ø¹ Ø¹Ù„ÙŠÙ‡Ø§ Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ«Ù‡Ø§</p>
    </div>
  {% endif %}

</section>
{% endblock %}
