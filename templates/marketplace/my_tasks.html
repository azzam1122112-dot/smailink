{% extends "base.html" %}
{% block title %}مهامي{% endblock %}

{% block extra_head %}
<style>
  :root {
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-dark: rgba(15, 23, 42, 0.9);
    --glass-border: 1px solid rgba(148, 163, 184, 0.25);
    --glass-shadow: 0 18px 45px rgba(15, 23, 42, 0.12);
  }

  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    border-radius: 1.5rem;
    border: var(--glass-border);
    box-shadow: var(--glass-shadow);
  }

  .dark .glass-card {
    background: var(--glass-dark);
    border-color: rgba(51, 65, 85, 0.9);
  }

  .info-card {
    border-radius: 1.25rem;
    border: 1px solid rgba(226, 232, 240, 0.9);
    background: linear-gradient(135deg, #f8fafc, #eef2ff);
    transition: all .25s ease;
  }

  .dark .info-card {
    border-color: rgba(51, 65, 85, 0.9);
    background: linear-gradient(135deg, #020617, #0f172a);
  }

  .info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18);
  }

  .status-badge {
    padding: 0.25rem 0.65rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    border-width: 1px;
    border-style: solid;
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    white-space: nowrap;
  }

  .fade-in {
    animation: fadeIn .5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-50 to-slate-100 dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 py-10 rtl" dir="rtl">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

    <!-- ===== البطاقة الرئيسية ===== -->
    <div class="glass-card fade-in overflow-hidden">

      <!-- ===== الهيدر ===== -->
      <div class="p-6 sm:p-8 border-b border-slate-200/60 dark:border-slate-800/80
                  bg-gradient-to-l from-indigo-50/95 via-slate-50/95 to-blue-50/90
                  dark:from-slate-900/95 dark:via-slate-950 dark:to-slate-900/95">

        <div class="flex items-start justify-between gap-4">
          <div class="space-y-1">
            <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">
              مهامي
            </h1>
            <p class="text-sm text-slate-600 dark:text-slate-400">
              الطلبات المسندة إليك داخل المنصّة.
            </p>
          </div>
          <div class="text-xs text-slate-500 dark:text-slate-400 pt-1">
            {% now "Y-m-d H:i" %}
          </div>
        </div>

        <!-- إحصاءات أعلى الصفحة -->
        {% if metrics %}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-6">
          <div class="info-card p-4 text-center">
            <div class="text-[11px] text-slate-500 dark:text-slate-400">إجمالي المهام</div>
            <div class="text-xl font-bold text-slate-900 dark:text-white">{{ metrics.total|default:"0" }}</div>
          </div>
          <div class="info-card p-4 text-center">
            <div class="text-[11px] text-slate-500 dark:text-slate-400">قيد التنفيذ</div>
            <div class="text-xl font-bold text-indigo-700 dark:text-indigo-200">{{ metrics.in_progress|default:"0" }}</div>
          </div>
          <div class="info-card p-4 text-center">
            <div class="text-[11px] text-slate-500 dark:text-slate-400">بانتظار اتفاق</div>
            <div class="text-xl font-bold text-amber-700 dark:text-amber-200">{{ metrics.pending_agreement|default:"0" }}</div>
          </div>
          <div class="info-card p-4 text-center">
            <div class="text-[11px] text-slate-500 dark:text-slate-400">مكتمل</div>
            <div class="text-xl font-bold text-emerald-700 dark:text-emerald-200">{{ metrics.completed|default:"0" }}</div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- ===== قائمة المهام ===== -->
      <div class="p-4 sm:p-6 lg:p-8">

        {% if requests %}
        <div class="space-y-4">

          {% for obj in requests %}
          <a href="{% url 'marketplace:request_detail' obj.pk %}"
             class="block info-card p-4 sm:p-5 hover:shadow-xl transition">

            <div class="flex items-start justify-between gap-3">

              <div class="flex-1 min-w-0">

                <!-- العنوان + الشارات -->
                <div class="flex flex-wrap items-center gap-2">
                  <div class="font-bold text-base sm:text-lg text-slate-900 dark:text-white truncate">
                    {{ obj.title|default:"طلب بدون عنوان" }}
                  </div>

                  <span class="status-badge bg-white/80 text-slate-700 border-slate-300 dark:bg-slate-900/70 dark:text-slate-200 dark:border-slate-600">
                    #{{ obj.pk }}
                  </span>

                  {% if obj.status == 'new' %}
                    <span class="status-badge bg-sky-50 text-sky-700 border-sky-200 dark:bg-sky-900/30 dark:text-sky-200 dark:border-sky-700">
                      {{ obj.get_status_display|default:"جديد" }}
                    </span>
                  {% elif obj.status == 'offer_selected' %}
                    <span class="status-badge bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/30 dark:text-amber-200 dark:border-amber-700">
                      {{ obj.get_status_display|default:"تم اختيار عرض" }}
                    </span>
                  {% elif obj.status == 'agreement_pending' %}
                    <span class="status-badge bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/30 dark:text-amber-200 dark:border-amber-700">
                      {{ obj.get_status_display|default:"بانتظار الاتفاقية" }}
                    </span>
                  {% elif obj.status == 'in_progress' %}
                    <span class="status-badge bg-indigo-50 text-indigo-800 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700">
                      {{ obj.get_status_display|default:"قيد التنفيذ" }}
                    </span>
                  {% elif obj.status == 'completed' %}
                    <span class="status-badge bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-200 dark:border-emerald-700">
                      {{ obj.get_status_display|default:"مكتمل" }}
                    </span>
                  {% elif obj.status == 'disputed' %}
                    <span class="status-badge bg-rose-50 text-rose-700 border-rose-200 dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-700">
                      {{ obj.get_status_display|default:"نزاع" }}
                    </span>
                  {% elif obj.status == 'cancelled' %}
                    <span class="status-badge bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800/40 dark:text-slate-300 dark:border-slate-700">
                      {{ obj.get_status_display|default:"ملغي" }}
                    </span>
                  {% else %}
                    <span class="status-badge bg-white/80 text-slate-700 border-slate-300 dark:bg-slate-900/70 dark:text-slate-200 dark:border-slate-600">
                      {{ obj.get_status_display|default:obj.status }}
                    </span>
                  {% endif %}

                  {% if obj.status == 'disputed' %}
                  <span class="status-badge bg-slate-200 text-slate-700 border-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:border-slate-500 text-[11px]">
                    مجمّد
                  </span>
                  {% endif %}
                </div>

                <!-- سطر العميل -->
                <div class="mt-1 text-xs sm:text-sm text-slate-500 dark:text-slate-400 truncate">
                  العميل:
                  <span class="font-semibold text-slate-800 dark:text-slate-200">
                    {{ obj.client|default:"—" }}
                  </span>
                  — أنت الموظف المعيّن
                </div>

                <!-- المدة والمبالغ -->
                <div class="mt-3 flex flex-wrap items-center gap-2 text-xs sm:text-[13px]">

                  <span class="px-2 py-1 rounded-xl border bg-sky-50 text-sky-700 border-sky-200 dark:bg-sky-900/20 dark:text-sky-200 dark:border-sky-700">
                    المدة (عميل): <b>{{ obj.estimated_duration_days|default:"—" }}</b> يوم
                  </span>

                  <span class="px-2 py-1 rounded-xl border bg-sky-50 text-sky-700 border-sky-200 dark:bg-sky-900/20 dark:text-sky-200 dark:border-sky-700">
                    المبلغ (عميل): <b>{{ obj.estimated_price|default:"—" }}</b> ريال
                  </span>

                  {% if obj.selected_offer %}
                  <span class="px-2 py-1 rounded-xl border bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-700">
                    المدة (عرض): <b>{{ obj.selected_offer.proposed_duration_days|default:"—" }}</b> يوم
                  </span>
                  <span class="px-2 py-1 rounded-xl border bg-amber-50 text-amber-800 border-amber-200 dark:bg-amber-900/20 dark:text-amber-200 dark:border-amber-700">
                    المبلغ (عرض): <b>{{ obj.selected_offer.proposed_price|default:"—" }}</b> ريال
                  </span>
                  {% endif %}

                  {% if obj.agreement %}
                  <span class="px-2 py-1 rounded-xl border bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-200 dark:border-emerald-700">
                    المدة (اتفاق): <b>{{ obj.agreement.duration_days|default:"—" }}</b> يوم
                  </span>
                  <span class="px-2 py-1 rounded-xl border bg-emerald-50 text-emerald-700 border-emerald-200 dark:bg-emerald-900/20 dark:text-emerald-200 dark:border-emerald-700">
                    المبلغ (اتفاق): <b>{{ obj.agreement.total_amount|default:"—" }}</b> ريال
                  </span>
                  {% endif %}
                </div>

              </div>

              <!-- وقت آخر تحديث -->
              <div class="text-[11px] text-slate-400 dark:text-slate-500 text-left sm:text-right">
                {{ obj.updated_at|date:"Y-m-d H:i"|default:"" }}
              </div>

            </div>
          </a>
          {% endfor %}
        </div>

        <!-- ترقيم الصفحات -->
        {% if is_paginated %}
        <div class="flex justify-center items-center gap-2 mt-8">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}"
             class="px-3 py-2 rounded-xl border bg-white/90 dark:bg-slate-900/90 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm text-slate-700 dark:text-slate-200">
            السابق
          </a>
          {% endif %}

          <span class="px-3 py-2 rounded-xl border bg-slate-100 dark:bg-slate-800 text-xs sm:text-sm text-slate-700 dark:text-slate-200">
            صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}
          </span>

          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}"
             class="px-3 py-2 rounded-xl border bg-white/90 dark:bg-slate-900/90 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm text-slate-700 dark:text-slate-200">
            التالي
          </a>
          {% endif %}
        </div>
        {% endif %}

        {% else %}
        <div class="py-14 text-center text-slate-500 dark:text-slate-400">
          لا توجد مهام مسندة حاليًا.
        </div>
        {% endif %}

      </div>
    </div>

  </div>
</section>
{% endblock %}
