{# marketplace/templates/marketplace/admin_request_reassign.html #}
{% extends "base.html" %}
{% block title %}إعادة إسناد طلب #{{ req.pk }}{% endblock %}

{% block content %}
<section class="py-8 max-w-2xl mx-auto rtl" dir="rtl">

  <div class="rounded-2xl border bg-white/85 dark:bg-slate-800/80 backdrop-blur shadow-glass-lg overflow-hidden">
    <!-- رأس -->
    <div class="p-6 border-b bg-gradient-to-l from-indigo-50 to-sky-50 dark:from-slate-800 dark:to-slate-900">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900 dark:text-white">
            إعادة إسناد طلب #{{ req.pk }}
          </h1>
          <p class="text-slate-600 dark:text-slate-300 text-sm mt-1">
            العنوان: <b class="truncate">{{ req.title|default:"—" }}</b>
          </p>
          <p class="text-slate-600 dark:text-slate-300 text-sm">
            المُعين الحالي: <b>{{ req.assigned_employee|default:"غير معيّن" }}</b>
          </p>
        </div>
        <a href="{{ req.get_absolute_url }}" class="px-4 py-2 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 shrink-0">
          رجوع
        </a>
      </div>

      {# تنبيه إداري #}
      <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 dark:border-amber-900 dark:bg-amber-900/20 p-3 text-amber-900 dark:text-amber-200 text-sm">
        <b>تنبيه:</b> إعادة الإسناد قد تغيّر صلاحيات الوصول والمراسلة الخاصة بالطلب. يتم تسجيل هذا الإجراء في سجلّ النظام.
      </div>
    </div>

    <!-- جسم -->
    <div class="p-6">

      {# أخطاء عامة #}
      {% if form.non_field_errors %}
        <div class="mb-4 rounded-xl border border-rose-200 bg-rose-50 dark:border-rose-900 dark:bg-rose-900/20 p-3 text-rose-700 dark:text-rose-200 text-sm">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <form id="reassignForm" method="post" class="space-y-5" novalidate>
        {% csrf_token %}

        {# أي حقول مخفية #}
        {% for hf in form.hidden_fields %}
          {{ hf }}
        {% endfor %}

        <!-- اختيار الموظف -->
        <div>
          <label for="{{ form.employee.id_for_label }}" class="block mb-1 font-semibold text-slate-800 dark:text-slate-100">
            اختر الموظف
          </label>
          <div class="mt-1">
            {{ form.employee }}
          </div>
          {% if form.employee.errors %}
            <p class="mt-1 text-sm text-rose-600 dark:text-rose-300">{{ form.employee.errors|join:", " }}</p>
          {% endif %}
          <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
            يُنصح بإسناد الطلب لموظف مناسب لمجاله لضمان جودة التنفيذ.
          </p>
        </div>

        {# حقل ملاحظة اختياري إذا وُجد في الفورم #}
        {% if form.note %}
        <div>
          <label for="{{ form.note.id_for_label }}" class="block mb-1 font-semibold text-slate-800 dark:text-slate-100">
            ملاحظة (اختياري)
          </label>
          <div class="mt-1">
            {{ form.note }}
          </div>
          {% if form.note.errors %}
            <p class="mt-1 text-sm text-rose-600 dark:text-rose-300">{{ form.note.errors|join:", " }}</p>
          {% endif %}
          <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
            ستظهر هذه الملاحظة في سجلّ الطلب للمراجعة لاحقًا.
          </p>
        </div>
        {% endif %}

        <!-- أزرار -->
        <div class="flex items-center gap-3 pt-2">
          <button id="submitBtn" type="submit" name="action" value="reassign"
                  class="px-5 py-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500 disabled:opacity-60 disabled:cursor-not-allowed">
            حفظ
          </button>
          <a class="px-5 py-3 rounded-xl border hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200"
             href="{{ req.get_absolute_url }}">
            إلغاء
          </a>
        </div>
      </form>
    </div>
  </div>

</section>

<!-- تحسينات UX: تأكيد وتعطيل الإرسال + تركيز الحقل -->
<script>
(function () {
  var form = document.getElementById('reassignForm');
  var submitBtn = document.getElementById('submitBtn');

  // تأكيد قبل الإرسال
  function confirmReassign() {
    var msg = 'سيتم إعادة إسناد هذا الطلب لموظف آخر.\nسيُسجَّل هذا الإجراء في السجلّ.\nمتابعة؟';
    return window.confirm(msg);
  }

  if (form) {
    // منع الإرسال المتكرر
    form.addEventListener('submit', function (e) {
      if (!confirmReassign()) {
        e.preventDefault();
        return false;
      }
      if (submitBtn) submitBtn.setAttribute('disabled', 'disabled');
    });

    // تركيز تلقائي على أول عنصر قابل للإدخال
    var first = form.querySelector('select, input, textarea');
    if (first && typeof first.focus === 'function') {
      setTimeout(function () { first.focus(); }, 50);
    }
  }
})();
</script>
{% endblock %}
