{# agreements/templates/agreements/agreement_form.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}Ø§ØªÙØ§Ù‚ÙŠØ© â€” Ø·Ù„Ø¨ #{{ req.id }}{% endblock %}

{% block extra_css %}
<style>
  .fade-in{animation:fadeIn .5s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .card-hover{transition:all .3s ease}.card-hover:hover{transform:translateY(-4px);box-shadow:0 12px 24px -8px rgba(0,0,0,.15)}
  .sticky-aside{position:sticky;top:88px}
  .form-input{transition:box-shadow .2s ease}.form-input:focus{box-shadow:0 0 0 3px rgba(37,99,235,.12)}
  .payment-item{transition:background-color .2s ease}.payment-item:hover{background-color:rgba(148,163,184,.08)}
  .kpi{background:linear-gradient(135deg,#f8fafc 0%,#eef2ff 100%)}.dark .kpi{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}
  .soft-border{border:1px solid rgba(148,163,184,.25)}
</style>
{% endblock %}

{% block content %}
<section class="py-8 max-w-6xl mx-auto rtl" dir="rtl">

  {# Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© #}
  <div class="rounded-2xl soft-border kpi p-6 shadow mb-8 fade-in card-hover">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
        <svg class="w-6 h-6 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293L19 8.586A1 1 0 0120 9V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <div>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø®Ø¯Ù…Ø©</h1>
        <p class="text-slate-600 dark:text-slate-300 text-sm">
          Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø·Ù„Ø¨
          <a class="text-blue-600 dark:text-blue-400 underline" href="{% url 'marketplace:request_detail' req.id %}">#{{ req.id }}</a>
        </p>
      </div>
    </div>

    <div class="grid md:grid-cols-4 gap-4 text-sm">
      <div class="bg-white/70 dark:bg-slate-800/70 p-3 rounded-lg soft-border">
        <div class="text-slate-500 dark:text-slate-400">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡</div>
        <div class="font-semibold text-lg mt-1 text-green-600 dark:text-green-400">
          {{ form.instance.total_amount|default:req.selected_offer.proposed_price|default:0|floatformat:2 }} Ø±.Ø³
        </div>
      </div>
      <div class="bg-white/70 dark:bg-slate-800/70 p-3 rounded-lg soft-border">
        <div class="text-slate-500 dark:text-slate-400">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
        <div class="font-semibold text-lg mt-1 text-amber-600 dark:text-amber-400">
          {{ form.instance.duration_days|default:0 }} ÙŠÙˆÙ…
        </div>
      </div>
      <div class="bg-white/70 dark:bg-slate-800/70 p-3 rounded-lg soft-border">
        <div class="text-slate-500 dark:text-slate-400">Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <div class="font-semibold text-lg mt-1">
          {{ form.instance.get_status_display|default:"â€”" }}
        </div>
      </div>
      <div class="bg-white/70 dark:bg-slate-800/70 p-3 rounded-lg soft-border">
        <div class="text-slate-500 dark:text-slate-400">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</div>
        <div id="live-sum" class="font-semibold text-lg mt-1">
          {{ form.instance.milestones.count|default:0 }}
        </div>
      </div>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    {# ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ…Ø®ÙÙŠ Ø¯Ø§Ø¦Ù…Ù‹Ø§ #}
    <input type="hidden" name="total_amount"
           value="{{ form.instance.total_amount|default:req.selected_offer.proposed_price|default:0 }}">

    <div class="grid md:grid-cols-3 gap-6">
      {# Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ #}
      <div class="md:col-span-2 space-y-6">

        {# ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ© #}
        <div class="rounded-2xl soft-border bg-white dark:bg-slate-800 p-6 shadow fade-in card-hover">
          <div class="flex items-center mb-5">
            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center ml-3">
              <svg class="w-5 h-5 text-blue-600 dark:text-blue-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5"/>
              </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-900 dark:text-white">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</h2>
          </div>

          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</label>
              {{ form.title }}
              {% for e in form.title.errors %}<p class="text-rose-600 text-sm mt-1">{{ e }}</p>{% endfor %}
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2">Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
              {{ form.duration_days }}
              {% if form.duration_days and form.duration_days.field and form.duration_days.field.disabled %}
                <p class="text-xs text-slate-500 mt-1">ØªÙ… Ù‚ÙÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©.</p>
              {% endif %}
              {% for e in form.duration_days.errors %}<p class="text-rose-600 text-sm mt-1">{{ e }}</p>{% endfor %}
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-2">Ù†Øµ Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</label>
              {{ form.text }}
              {% for e in form.text.errors %}<p class="text-rose-600 text-sm mt-1">{{ e }}</p>{% endfor %}
            </div>
          </div>
        </div>

        {# Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Formset) #}
        <div class="rounded-2xl soft-border bg-white dark:bg-slate-800 p-6 shadow fade-in card-hover">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center ml-3">
                <svg class="w-5 h-5 text-green-600 dark:text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
              </div>
              <h3 class="text-xl font-bold">Ù…Ø±Ø§Ø­Ù„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
            </div>
            <button type="button" id="add-row" class="btn btn-secondary btn-glow">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
          </div>

          {{ formset.management_form }}
          {% if formset.non_form_errors %}
            <div class="p-3 rounded bg-rose-50 text-rose-700 soft-border mb-3">
              {% for e in formset.non_form_errors %}<div>{{ e }}</div>{% endfor %}
            </div>
          {% endif %}

          <div id="rows" class="space-y-4">
            {% for f in formset.forms %}
              <div class="rounded-xl soft-border p-4 payment-item milestone-row" data-row-index="{{ forloop.counter0 }}">
                {# Ù…Ù‡Ù…: ØªØ¶Ù…ÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ø¹Ø¯Ù… Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙˆÙ Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ #}
                {{ f.id }}

                <div class="flex items-center gap-3 mb-3">
                  <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-sm font-bold text-slate-700 dark:text-slate-200 milestone-order">{{ forloop.counter }}</div>
                  <input type="hidden" class="milestone-order-value" name="{{ f.order.html_name }}" value="{{ f.order.value|default:forloop.counter }}">
                  {# Ø¶Ù…Ø§Ù† amount=0 Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙÙˆØ±Ù… - Ø³Ù†Ø¶ÙŠÙÙ‡ Ø¨Ø§Ù„Ù€JS Ø£ÙŠØ¶Ù‹Ø§ ÙƒØ¶Ù…Ø§Ù† #}
                  <input type="hidden" name="{{ f.prefix }}-amount" value="0">
                </div>

                <div class="grid md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-semibold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
                    {{ f.title }}
                  </div>
                  <div>
                    <label class="text-sm font-semibold">Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
                    {{ f.due_days }}
                  </div>
                </div>

                {% if formset.can_delete %}
                  <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600 flex items-center justify-between">
                    <span class="text-xs text-slate-500"><span class="text-rose-500">âš ï¸</span> Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span>
                    <button type="button" class="btn btn-sm btn-danger delete-row">Ø­Ø°Ù</button>
                  </div>
                  {{ f.DELETE }}
                {% endif %}

                {% for e in f.title.errors %}<p class="text-rose-600 text-sm mt-2">{{ e }}</p>{% endfor %}
                {% for e in f.due_days.errors %}<p class="text-rose-600 text-sm mt-2">{{ e }}</p>{% endfor %}
                {% for e in f.non_field_errors %}<p class="text-rose-600 text-sm mt-2">{{ e }}</p>{% endfor %}
              </div>
            {% endfor %}
          </div>

          <div class="mt-4 p-3 rounded-lg soft-border bg-blue-50 dark:bg-blue-900/20">
            <p class="text-sm text-blue-800 dark:text-blue-300">
              âœ¨ <strong>Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:</strong> Ø­Ø¯Ù‘ÙØ¯ Ù…Ø±Ø§Ø­Ù„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø¹ Ù…Ø¯Ø© ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©. Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠÙØ­Ø¯Ù‘ÙØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
            </p>
          </div>
        </div>

      </div>

      {# Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ #}
      <aside class="space-y-6 sticky-aside">
        <div class="rounded-2xl soft-border bg-white dark:bg-slate-800 p-6 shadow fade-in card-hover">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø«Ø¨Ù‘ØªØ©</h3>
            <span class="text-xs rounded-full bg-slate-100 dark:bg-slate-700 px-3 py-1">
              {{ form.instance.clause_items.count }} Ø¨Ù†Ø¯
            </span>
          </div>

          {% if form.instance.clause_items.count == 0 %}
            <div class="p-3 rounded bg-amber-50 dark:bg-amber-900/20 soft-border text-amber-800 dark:text-amber-200">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø«Ø¨ØªØ© Ø¨Ø¹Ø¯.
            </div>
          {% endif %}

          <ol class="list-decimal pr-5 space-y-3 max-h-64 overflow-auto">
            {% for item in form.instance.clause_items.all %}
              <li class="leading-7 p-3 rounded bg-slate-50 dark:bg-slate-700/40 soft-border">
                {% if item.clause %}
                  <strong>{{ item.clause.title }}:</strong>
                  <span class="text-slate-600 dark:text-slate-300">{{ item.clause.body }}</span>
                {% else %}
                  <span class="text-slate-600 dark:text-slate-300">{{ item.custom_text }}</span>
                {% endif %}
              </li>
            {% empty %}
              <li class="text-center text-slate-500 py-2">â€”</li>
            {% endfor %}
          </ol>

          <div class="mt-4">
            {% if user.is_authenticated %}
              {% if user.is_staff or user.is_superuser or user.id == form.instance.employee_id %}
                <a href="{% url 'agreements:finalize_clauses' form.instance.pk %}" class="btn btn-primary w-full btn-glow">ØªØ«Ø¨ÙŠØª/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯</a>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <div class="rounded-2xl soft-border bg-slate-50 dark:bg-slate-800/60 p-4 text-sm">
          <ul class="space-y-2 text-slate-600 dark:text-slate-300">
            <li>âœ¨ <strong>ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ:</strong> ÙŠÙØ­Ø¯Ù‘Ø« Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø§Ù„Ø­Ø°Ù</li>
            <li>â• <strong>Ø¥Ø¶Ø§ÙØ© Ø³Ù‡Ù„Ø©:</strong> Ø§Ø¶ØºØ· â€œ+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©â€</li>
            <li>ğŸ—‘ï¸ <strong>Ø­Ø°Ù ÙØ¹Ù„ÙŠ:</strong> Ø§Ù„Ø­Ø°Ù ÙŠÙˆØ³Ù‘ÙÙ… Ø§Ù„ØµÙ Ø¨Ù€ DELETE Ù„Ø¥Ø²Ø§Ù„ØªÙ‡ ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸</li>
            <li>ğŸ“ <strong>Ù†Øµ Ø¢Ù…Ù†:</strong> ØªØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆØ³ÙˆÙ… Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©</li>
          </ul>
        </div>
      </aside>
    </div>

    {# Ø§Ù„Ø£Ø²Ø±Ø§Ø± #}
    <div class="mt-8 flex flex-wrap gap-3 justify-center fade-in">
      <button id="btn-save" name="action" value="save" class="btn btn-primary btn-glow px-6">Ø­ÙØ¸ (Ù…Ø³ÙˆØ¯Ø©)</button>
      <button id="btn-send" name="action" value="send" class="btn btn-success btn-glow px-6">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
      <a href="{% url 'marketplace:request_detail' req.id %}" class="btn btn-light btn-glow px-6">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨</a>
    </div>
  </form>

  {# Ù‚Ø§Ù„Ø¨ ØµÙ Ø¬Ø¯ÙŠØ¯ (Ù…Ù† empty_form) #}
  <template id="empty-form">
    <div class="rounded-xl soft-border p-4 mt-4 payment-item milestone-row" data-row-index="__new__">
      {{ formset.empty_form.id }}
      <div class="flex items-center gap-3 mb-3">
        <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center text-sm font-bold text-slate-700 dark:text-slate-200 milestone-order">1</div>
        <input type="hidden" class="milestone-order-value" name="{{ formset.prefix }}-__prefix__-order" value="1">
        <input type="hidden" name="{{ formset.prefix }}-__prefix__-amount" value="0">
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-semibold">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
          {{ formset.empty_form.title }}
        </div>
        <div>
          <label class="text-sm font-semibold">Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)</label>
          {{ formset.empty_form.due_days }}
        </div>
      </div>
      {% if formset.can_delete %}
        <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-600 flex items-center justify-between">
          <span class="text-xs text-slate-500"><span class="text-rose-500">âš ï¸</span> Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</span>
          <button type="button" class="btn btn-sm btn-danger delete-row">Ø­Ø°Ù</button>
        </div>
        {{ formset.empty_form.DELETE }}
      {% endif %}
    </div>
  </template>

  <script>
  (function(){
    const prefix  = "{{ formset.prefix }}";
    const totalEl = document.getElementById(prefix + "-TOTAL_FORMS");
    const rows    = document.getElementById("rows");
    const addBtn  = document.getElementById("add-row");
    const btnSend = document.getElementById("btn-send");

    function updateMilestoneOrders(){
      const items = rows.querySelectorAll(".milestone-row:not([style*='display: none'])");
      items.forEach(function(el, idx){
        const orderInput = el.querySelector(".milestone-order-value");
        const orderDisp  = el.querySelector(".milestone-order");
        const n = idx + 1;
        if(orderInput) orderInput.value = n;
        if(orderDisp)  orderDisp.textContent = n;
      });
      const live = document.getElementById("live-sum");
      if(live) live.textContent = String(items.length);
    }

    function ensureZeroAmount(row, idx){
      var hidden = row.querySelector("input[type='hidden'][name$='-amount']");
      if(!hidden){
        hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = prefix + "-" + idx + "-amount";
        row.appendChild(hidden);
      }
      hidden.value = "0";
    }

    function setupDeleteButtons(){
      rows.querySelectorAll(".delete-row").forEach(function(btn){
        if(btn.dataset.hasListener) return;
        btn.addEventListener("click", function(e){
          e.preventDefault();
          const row = this.closest(".milestone-row");
          const del = row.querySelector("input[type='checkbox'][name*='-DELETE']");
          if(del){ del.checked = true; row.style.display = "none"; }
          updateMilestoneOrders();
        });
        btn.dataset.hasListener = "1";
      });
    }

    addBtn && addBtn.addEventListener("click", function(e){
      e.preventDefault();
      const idx = parseInt(totalEl.value || "0", 10);
      const tpl = document.getElementById("empty-form");
      const frag = tpl.content.cloneNode(true);
      const html = frag.querySelector(".milestone-row").outerHTML.replace(/__prefix__/g, idx);
      const wrapper = document.createElement("div");
      wrapper.innerHTML = html;
      const newRow = wrapper.firstElementChild;
      newRow.setAttribute("data-row-index", idx);
      rows.appendChild(newRow);
      totalEl.value = String(idx + 1);
      ensureZeroAmount(newRow, idx);
      setupDeleteButtons();
      updateMilestoneOrders();
    });

    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll("input,textarea,select").forEach(function(el){ el.classList.add("form-input"); });
      if(btnSend){ btnSend.disabled = false; btnSend.classList.remove("opacity-50"); }
      rows.querySelectorAll(".milestone-row").forEach(function(row, i){ ensureZeroAmount(row, i); });
      setupDeleteButtons();
      updateMilestoneOrders();
    });

    document.forms[0].addEventListener("submit", function(){
      const items = rows.querySelectorAll(".milestone-row");
      items.forEach(function(row, i){ ensureZeroAmount(row, i); });
    });
  })();
  </script>

</section>
{% endblock %}
