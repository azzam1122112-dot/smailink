{% extends "base.html" %}
{% load humanize %}

{% block title %}ุงููุจุงูุบ ุงููุฌูุฏุฉ ุจุงููุฒุงุนุงุช{% endblock %}

{% block content %}
<section class="page-section" dir="rtl">
  <div class="container mx-auto px-4 py-6">

    <div class="mb-6">
      <div class="section-badge">โ๏ธ Finance Disputes</div>
      <h1 class="text-2xl md:text-3xl font-extrabold mt-2">ุงููุจุงูุบ ุงููุฌูุฏุฉ ุจุงููุฒุงุนุงุช</h1>
      <p class="text-sm text-gray-600 mt-1">
        ุตุงูู ุงูููุธู ุงููุฌูุฏ = P - ุนูููุฉ ุงูููุตุฉ. ูุงูุฑุฏ ููุนููู ุญุณุจ ุฅุฌูุงูู ูุง ุฏูุนู.
      </p>
    </div>

    {# KPIs #}
    <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;">
      <div class="profile-section" style="background:linear-gradient(135deg,#fee2e2 0%, #fff 100%);">
        <div class="card-section-title">๐ซ ุตุงูู ุงูููุธููู ุงููุฌูุฏ</div>
        <div class="stat-value">{{ hold_employee_total|default:0|floatformat:2 }} ุฑูุงู</div>
      </div>
      <div class="profile-section" style="background:linear-gradient(135deg,#fef3c7 0%, #fff 100%);">
        <div class="card-section-title">๐ณ ูุจุงูุบ ุงูุนููุงุก ุงููุงุจูุฉ ููุฑุฏ</div>
        <div class="stat-value">{{ hold_client_total|default:0|floatformat:2 }} ุฑูุงู</div>
      </div>
    </div>

    {# ุฌุฏูู ุงููุฒุงุนุงุช #}
    <div class="profile-section mt-6">
      <div class="card-section-title">ุงููุฒุงุนุงุช ุงููุดุทุฉ</div>

      {% if rows %}
        <div class="overflow-x-auto rounded-2xl bg-white shadow mt-3">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-600 border-b">
                <th class="py-2 px-3 text-right">ุงููุฒุงุน</th>
                <th class="py-2 px-3 text-right">ุงูุทูุจ</th>
                <th class="py-2 px-3 text-right">ุงูููุธู</th>
                <th class="py-2 px-3 text-right">ุงููุงุชูุฑุฉ</th>
                <th class="py-2 px-3 text-right">ุตุงูู ุงูููุธู ุงููุฌูุฏ</th>
                <th class="py-2 px-3 text-right">ูุจูุบ ุงูุนููู</th>
                <th class="py-2 px-3 text-right">ุงูุญุงูุฉ</th>
                <th class="py-2 px-3 text-right">ุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
                <tr class="border-b hover:bg-gray-50">
                  <td class="py-2 px-3">
                    #{{ r.dispute.pk }} โ {{ r.dispute.title|default:"ูุฒุงุน" }}
                  </td>

                  <td class="py-2 px-3">
                    <a href="{% url 'marketplace:request_detail' r.request.pk %}">
                      #{{ r.request.pk }}
                    </a>
                  </td>

                  <td class="py-2 px-3">{{ r.agreement.employee }}</td>

                  <td class="py-2 px-3">
                    {% if r.invoice %}
                      <a href="{% url 'finance:invoice_detail' r.invoice.pk %}">#{{ r.invoice.pk }}</a>
                    {% else %}
                      โ
                    {% endif %}
                  </td>

                  <td class="py-2 px-3 font-semibold">{{ r.employee_hold|floatformat:2 }} ุฑูุงู</td>

                  <td class="py-2 px-3">{{ r.client_hold|floatformat:2 }} ุฑูุงู</td>

                  <td class="py-2 px-3">
                    {% if r.is_paid %}
                      <span class="badge badge-verified">ุงููุงุชูุฑุฉ ูุฏููุนุฉ</span>
                    {% else %}
                      <span class="badge badge-pending">ุบูุฑ ูุฏููุนุฉ</span>
                    {% endif %}
                  </td>

                  <td class="py-2 px-3">
                    {% if r.is_paid %}
                      <div style="display:flex;flex-wrap:wrap;gap:.25rem;align-items:center;">

                        {# Release #}
                        {% if r.payout_latest %}
                          <span class="badge badge-default">Payout ููุฌูุฏ</span>
                        {% else %}
                          <form method="post" action="{% url 'finance:dispute_release' r.dispute.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-primary btn-sm" type="submit">Release ููููุธู</button>
                          </form>
                        {% endif %}

                        {# Refund #}
                        <form method="post" action="{% url 'finance:dispute_refund' r.dispute.pk %}">
                          {% csrf_token %}
                          <input name="amount" class="input input-sm w-28" placeholder="ูุจูุบ ุงูุฑุฏ" value="{{ r.client_hold|floatformat:2 }}">
                          <button class="btn btn-outline btn-sm" type="submit">Refund ููุนููู</button>
                        </form>

                      </div>
                    {% else %}
                      โ
                    {% endif %}
                  </td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">ูุง ุชูุฌุฏ ูุฒุงุนุงุช ูุดุทุฉ ุญุงููุงู.</p>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
