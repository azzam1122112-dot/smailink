{# finance/templates/finance/settings.html #}
{% extends "base.html" %}

{% block title %}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©{% endblock %}

{% block content %}
<section class="page-section finance-settings">
  <div class="container">

    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">
        âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      </div>
      <h1 class="section-title">
        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      </h1>
      <p class="section-description">
        Ø§Ù„Ù‚ÙŠÙ… Ù‡Ù†Ø§ ÙƒÙ†ÙØ³ÙØ¨ Ø¨ÙŠÙ† 0 Ùˆ1 (Ù…Ø«Ø§Ù„: 0.10 = 10ÙªØŒ 0.15 = 15Ùª).
      </p>

      {# ===== ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© ===== #}
      <div class="profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1rem;">
        <div class="card-section-title" style="color: var(--primary-800);">
          âœ… Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
        </div>
        <ul class="text-sm" style="margin-top: .75rem; color: var(--dark-700); line-height: 1.9;">
          <li>Ø§Ù„Ø¹Ù…ÙŠÙ„ <b>Ù„Ø§ ÙŠØªØ­Ù…Ù‘Ù„</b> Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©.</li>
          <li>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (P) + Ø¶Ø±ÙŠØ¨Ø© P ÙÙ‚Ø·.</li>
          <li>ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù = P âˆ’ (P Ã— Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©).</li>
        </ul>
      </div>
    </div>

    <div class="settings-container" style="max-width: 600px; margin: 0 auto;">

      {# ===== Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===== #}
      <div class="profile-section">
        <form method="post" class="settings-form" id="settingsForm" novalidate>
          {% csrf_token %}

          {# ===== Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© ===== #}
          <div class="form-field">
            <label for="{{ form.platform_fee_percent.id_for_label }}" class="form-label">
              ğŸ’¼ Ù†Ø³Ø¨Ø© Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø© (0..1)
            </label>

            <div class="input-with-preview">
              {{ form.platform_fee_percent }}
              <div class="preview-value" id="feePreview">
                {{ form.platform_fee_percent.value|default:0|floatformat:4 }}
              </div>
            </div>

            {% if form.platform_fee_percent.errors %}
              <div class="field-error">
                {{ form.platform_fee_percent.errors|join:", " }}
              </div>
            {% endif %}

            {# Ø¹Ø±Ø¶ ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© ØµØ­ÙŠØ­Ø© #}
            <div class="preview-percent" id="feePercent">
              {{ form.platform_fee_percent.value|default:0|floatformat:4 }} Ã— 100 = 
              {{ form.platform_fee_percent.value|default:0|floatformat:4|add:"0"|floatformat:4 }}%
            </div>

            <p class="text-xs" style="margin-top:.5rem;color:var(--dark-500);">
              ØªÙØ®ØµÙ… Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù ÙÙ‚Ø· ÙˆÙ„Ø§ ØªØ¯Ø®Ù„ Ø¶Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„.
            </p>
          </div>

          {# ===== Ù†Ø³Ø¨Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© ===== #}
          <div class="form-field">
            <label for="{{ form.vat_rate.id_for_label }}" class="form-label">
              ğŸ›ï¸ Ù†Ø³Ø¨Ø© Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© VAT (0..1)
            </label>

            <div class="input-with-preview">
              {{ form.vat_rate }}
              <div class="preview-value" id="vatPreview">
                {{ form.vat_rate.value|default:0|floatformat:4 }}
              </div>
            </div>

            {% if form.vat_rate.errors %}
              <div class="field-error">
                {{ form.vat_rate.errors|join:", " }}
              </div>
            {% endif %}

            {# Ø¹Ø±Ø¶ ÙƒÙ†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© ØµØ­ÙŠØ­Ø© #}
            <div class="preview-percent" id="vatPercent">
              {{ form.vat_rate.value|default:0|floatformat:4 }} Ã— 100 = 
              {{ form.vat_rate.value|default:0|floatformat:4|add:"0"|floatformat:4 }}%
            </div>

            <p class="text-xs" style="margin-top:.5rem;color:var(--dark-500);">
              ØªÙØ­Ø³Ø¨ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (P) ÙÙ‚Ø·.
            </p>
          </div>

          {# ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===== #}
          <div class="form-actions employee-actions" style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--dark-200);">
            <button type="submit" class="btn btn-primary" id="submitBtn">
              ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </button>
            <button type="reset" class="btn btn-outline" id="resetBtn">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            </button>
          </div>
        </form>

        {# ===== Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ===== #}
        <div class="current-values profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 2rem;">
          <div class="card-section-title" style="color: var(--primary-700);">
            ğŸ“Š Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ÙƒØ§Ø´
          </div>

          <div class="values-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div class="value-item">
              <div class="value-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©:</div>
              <div class="value-amount">
                {{ cached_fee|default:"0" }} ({{ cached_fee|default:0|floatformat:4 }} Ã—100 = {{ cached_fee|default:0|floatformat:4|add:"0"|floatformat:4 }}%)
              </div>
            </div>

            <div class="value-item">
              <div class="value-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© VAT:</div>
              <div class="value-amount">
                {{ cached_vat|default:"0" }} ({{ cached_vat|default:0|floatformat:4 }} Ã—100 = {{ cached_vat|default:0|floatformat:4|add:"0"|floatformat:4 }}%)
              </div>
            </div>
          </div>

          <p class="card-section-note" style="margin-top: 1rem;">
            Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù….
          </p>
        </div>
      </div>

      {# ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ===== #}
      <div class="help-section profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200); margin-top: 1.5rem;">
        <div class="card-section-title" style="color: var(--secondary-700);">
          ğŸ’¡ Ø£Ù…Ø«Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
        </div>

        <div class="examples-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div class="example-item">
            <div class="example-value">0.05 = 5%</div>
            <div class="example-desc">Ø¹Ù…ÙˆÙ„Ø© Ù…Ù†Ø®ÙØ¶Ø©</div>
          </div>
          <div class="example-item">
            <div class="example-value">0.10 = 10%</div>
            <div class="example-desc">Ø¹Ù…ÙˆÙ„Ø© Ù…ØªÙˆØ³Ø·Ø©</div>
          </div>
          <div class="example-item">
            <div class="example-value">0.15 = 15%</div>
            <div class="example-desc">Ø¹Ù…ÙˆÙ„Ø© Ù…Ø±ØªÙØ¹Ø©</div>
          </div>
          <div class="example-item">
            <div class="example-value">0.00 = 0%</div>
            <div class="example-desc">Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙˆÙ„Ø©</div>
          </div>
        </div>

        <p class="text-xs" style="margin-top:1rem;color:var(--secondary-700);">
          Ù…Ø«Ø§Ù„ Ø³Ø±ÙŠØ¹: Ø¥Ø°Ø§ ÙƒØ§Ù† P=1000 ÙˆVAT=0.15 â†’ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ = 1150.  
          ÙˆØ¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø© 0.10 â†’ ØµØ§ÙÙŠ Ø§Ù„Ù…ÙˆØ¸Ù = 900.
        </p>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    if (typeof initScrollReveal === 'function') initScrollReveal();
    if (typeof initButtonEffects === 'function') initButtonEffects();

    const form = document.getElementById('settingsForm');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    const feeInput = document.getElementById('{{ form.platform_fee_percent.id_for_label }}');
    const vatInput = document.getElementById('{{ form.vat_rate.id_for_label }}');
    const feePreview = document.getElementById('feePreview');
    const vatPreview = document.getElementById('vatPreview');
    const feePercent = document.getElementById('feePercent');
    const vatPercent = document.getElementById('vatPercent');

    function updatePreview(input, preview, percent) {
      if (!input || !preview || !percent) return;

      const value = parseFloat(input.value) || 0;
      preview.textContent = value.toFixed(4);
      percent.textContent = (value * 100).toFixed(2) + '%';

      if (value > 0.15) {
        percent.style.color = '#ef4444';
      } else if (value > 0.10) {
        percent.style.color = '#f59e0b';
      } else if (value > 0.05) {
        percent.style.color = '#10b981';
      } else {
        percent.style.color = 'var(--dark-500)';
      }
    }

    function validateInput(input) {
      const value = parseFloat(input.value);
      if (isNaN(value)) {
        input.style.borderColor = '#ef4444';
        return false;
      }
      if (value < 0 || value > 1) {
        input.style.borderColor = '#ef4444';
        return false;
      }
      input.style.borderColor = '#10b981';
      return true;
    }

    if (feeInput) {
      feeInput.addEventListener('input', function() {
        updatePreview(feeInput, feePreview, feePercent);
        validateInput(feeInput);
        this.style.transform = 'scale(1.02)';
        setTimeout(() => this.style.transform = 'scale(1)', 150);
      });
      feeInput.addEventListener('blur', function() {
        validateInput(feeInput);
      });
    }

    if (vatInput) {
      vatInput.addEventListener('input', function() {
        updatePreview(vatInput, vatPreview, vatPercent);
        validateInput(vatInput);
        this.style.transform = 'scale(1.02)';
        setTimeout(() => this.style.transform = 'scale(1)', 150);
      });
      vatInput.addEventListener('blur', function() {
        validateInput(vatInput);
      });
    }

    if (form) {
      form.addEventListener('submit', function(e) {
        let isValid = true;
        if (!validateInput(feeInput)) isValid = false;
        if (!validateInput(vatInput)) isValid = false;

        if (!isValid) {
          e.preventDefault();
          if (typeof showToast === 'function') {
            showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø© Ø¨ÙŠÙ† 0 Ùˆ 1', 'error');
          }
          return false;
        }

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        }

        if (typeof showToast === 'function') {
          showToast('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©...', 'info');
        }
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        if (typeof showToast === 'function') {
          showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…', 'info');
        }
        setTimeout(() => {
          if (feeInput) updatePreview(feeInput, feePreview, feePercent);
          if (vatInput) updatePreview(vatInput, vatPreview, vatPercent);
        }, 100);
      });
    }

    const inputs = form ? form.querySelectorAll('input') : [];
    inputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.style.borderColor = 'var(--primary-500)';
        this.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
      });
      input.addEventListener('blur', function() {
        this.style.boxShadow = '';
      });
    });

    setTimeout(() => {
      if (feeInput) updatePreview(feeInput, feePreview, feePercent);
      if (vatInput) updatePreview(vatInput, vatPreview, vatPercent);
    }, 100);

  })();
  </script>

  <style>
  .finance-settings .settings-container { max-width: 600px; }
  .finance-settings .form-field { margin-bottom: 2rem; position: relative; }
  .finance-settings .form-label {
    display: block; font-weight: 600; color: var(--dark-700);
    margin-bottom: 0.5rem; font-size: 0.95rem;
  }
  .finance-settings .input-with-preview { display: flex; align-items: center; gap: 1rem; }
  .finance-settings .input-with-preview input {
    flex: 1; padding: 0.75rem 1rem; border: 1px solid var(--dark-300);
    border-radius: var(--radius-lg); background: var(--white);
    font-family: inherit; font-size: 1rem; transition: var(--transition);
  }
  .finance-settings .input-with-preview input:focus {
    outline: none; border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }
  .finance-settings .preview-value {
    padding: 0.5rem 1rem; background: var(--dark-100);
    border-radius: var(--radius); font-family: monospace; font-size: 0.9rem;
    color: var(--dark-700); min-width: 80px; text-align: center;
  }
  .finance-settings .preview-percent {
    margin-top: 0.5rem; font-weight: 600; font-size: 0.9rem;
    transition: color 0.3s ease;
  }
  .finance-settings .field-error {
    color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;
  }
  .finance-settings .values-grid { grid-template-columns: 1fr 1fr; }
  .finance-settings .value-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.75rem; background: var(--white); border-radius: var(--radius);
    border: 1px solid var(--primary-200);
  }
  .finance-settings .value-label {
    color: var(--primary-600); font-weight: 600; font-size: 0.9rem;
  }
  .finance-settings .value-amount {
    color: var(--primary-700); font-weight: 700; font-family: monospace; font-size: 1rem;
    text-align: left;
  }
  .finance-settings .examples-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
  .finance-settings .example-item {
    text-align: center; padding: 1rem; background: var(--white);
    border-radius: var(--radius-lg); border: 1px solid var(--secondary-200);
  }
  .finance-settings .example-value {
    font-weight: 700; color: var(--secondary-700); margin-bottom: 0.25rem; font-family: monospace;
  }
  .finance-settings .example-desc { color: var(--secondary-600); font-size: 0.875rem; }
  .finance-settings .form-actions { display: flex; gap: 1rem; justify-content: flex-start; }

  @media (max-width: 768px) {
    .finance-settings .input-with-preview { flex-direction: column; align-items: stretch; }
    .finance-settings .preview-value { order: -1; margin-bottom: 0.5rem; }
    .finance-settings .values-grid { grid-template-columns: 1fr; }
    .finance-settings .examples-grid { grid-template-columns: repeat(2, 1fr); }
    .finance-settings .form-actions { flex-direction: column; }
    .finance-settings .form-actions .btn { width: 100%; }
  }
  @media (max-width: 480px) {
    .finance-settings .examples-grid { grid-template-columns: 1fr; }
    .finance-settings .value-item {
      flex-direction: column; align-items: flex-start; gap: 0.25rem;
    }
    .finance-settings .value-amount { text-align: right; }
  }

  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .finance-settings .profile-section { animation: slideInUp 0.6s ease-out; }
  .finance-settings .form-field:nth-child(1) { animation-delay: 0.1s; }
  .finance-settings .form-field:nth-child(2) { animation-delay: 0.2s; }
  .finance-settings .current-values { animation-delay: 0.3s; }
  .finance-settings .help-section { animation-delay: 0.4s; }
  </style>
{% endblock %}
