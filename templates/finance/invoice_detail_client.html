{# finance/templates/finance/invoice_detail_client.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}{% endblock %}

{% block content %}
<section class="page-section invoice-detail-page">
  <div class="container">
    
    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">
        ğŸ§¾ ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}
      </div>
      <h1 class="section-title">
        ÙØ§ØªÙˆØ±Ø© #{{ inv.id }}
      </h1>
      <p class="section-description">
        A{{ inv.agreement_id }}{% if inv.agreement and inv.agreement.request_id %} / R{{ inv.agreement.request_id }}{% endif %}
      </p>
    </div>

    <div class="invoice-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
      
      {# ===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº (Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„) ===== #}
      <div class="profile-section">
        <div class="card-section-title">ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
        <div class="amount-breakdown">

          <div class="amount-row">
            <span class="amount-label">
              Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
              {% if inv.vat_percent %}
                <span class="amount-percent">Ø¶Ø±ÙŠØ¨Ø© {{ inv.vat_percent|floatformat:2 }}%</span>
              {% endif %}
            </span>
            <span class="amount-value">
              {{ breakdown.P|floatformat:2 }} Ø±.Ø³
            </span>
          </div>

          <div class="amount-row">
            <span class="amount-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT)</span>
            <span class="amount-value">
              {{ breakdown.vat_amount|floatformat:2 }} Ø±.Ø³
            </span>
          </div>

          <div class="amount-row total-row">
            <span class="amount-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span>
            <span class="amount-value">
              {{ breakdown.client_total|floatformat:2 }} Ø±.Ø³
            </span>
          </div>

        </div>

        <div class="quick-summary profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
          <div class="card-section-title" style="color: var(--primary-700);">ğŸ“Š Ù…Ù„Ø®Øµ</div>
          <div class="summary-items">
            <div class="summary-item">
              <span class="summary-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
              <span class="summary-value">
                {{ breakdown.client_total|floatformat:2 }} Ø±.Ø³
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
              <span class="summary-value">{{ breakdown.vat_amount|floatformat:2 }} Ø±.Ø³</span>
            </div>
          </div>
        </div>
      </div>

      {# ===== Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯ ===== #}
      <div class="profile-section">
        <div class="card-section-title">ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯</div>
        
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
            <span class="status-value">
              {% if inv.status == 'unpaid' and inv.paid_ref %}
                <span class="badge badge-warning" style="background-color: #fffbeb; color: #d97706;">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
              {% else %}
                <span class="badge {% if inv.is_paid %}badge-verified{% else %}badge-pending{% endif %}">
                  {{ inv.get_status_display }}
                </span>
              {% endif %}
            </span>
          </div>
          
          <div class="status-item">
            <span class="status-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span>
            <span class="status-value">{% if inv.issued_at %}{{ inv.issued_at|date:"Y-m-d H:i" }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
            <span class="status-value">{% if inv.paid_at %}{{ inv.paid_at|date:"Y-m-d H:i" }}{% else %}â€”{% endif %}</span>
          </div>
          
          <div class="status-item">
            <span class="status-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
            <span class="status-value">{% if inv.method %}{{ inv.method }}{% else %}â€”{% endif %}</span>
          </div>
        </div>

        {% if inv.is_paid %}
          <div class="payment-status profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
            <div class="payment-success" style="text-align: center; padding: 1.5rem;">
              <div class="success-icon" style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
              <h3 class="card-section-title" style="color: var(--primary-700); margin-bottom: 0.5rem;">
                Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©
              </h3>
              <p class="card-section-note">
                ØªÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ {{ inv.paid_at|date:"Y-m-d H:i" }}
              </p>
              {% if inv.method %}
                <p class="card-section-note" style="margin-top: 0.5rem;">
                  Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯: <strong>{{ inv.method }}</strong>
                </p>
              {% endif %}
            </div>
          </div>
        {% elif inv.paid_ref %}
          <div class="payment-status profile-section" style="background: #fffbeb; border-color: #d97706; margin-top: 1.5rem;">
            <div class="payment-pending" style="text-align: center; padding: 1.5rem;">
              <div class="pending-icon" style="font-size: 3rem; margin-bottom: 1rem;">â³</div>
              <h3 class="card-section-title" style="color: #d97706; margin-bottom: 0.5rem;">
                Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
              </h3>
              <p class="card-section-note">
                ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ ({{ inv.paid_ref }}) ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡.
              </p>
            </div>
          </div>
        {% else %}
          <div class="payment-action profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200); margin-top: 1.5rem; text-align: center;">
             <p class="card-section-note" style="margin-bottom: 1rem;">
               ÙŠØ±Ø¬Ù‰ Ø³Ø¯Ø§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª.
             </p>
             <a href="{% url 'finance:checkout_invoice' inv.id %}" class="btn btn-primary">
               ğŸ’³ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¯ÙØ¹
             </a>
          </div>
        {% endif %}
      </div>
    </div>

    {# ===== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ===== #}
    <div class="additional-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
      
      {% if inv.agreement %}
      <div class="profile-section">
        <div class="card-section-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</div>
        <div class="agreement-info">
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©:</span>
            <span class="info-value">A{{ inv.agreement_id }}</span>
          </div>
          {% if inv.agreement.request_id %}
          <div class="info-row">
            <span class="info-label">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</span>
            <span class="info-value">R{{ inv.agreement.request_id }}</span>
          </div>
          {% endif %}
          {% if inv.agreement.employee %}
          <div class="info-row">
            <span class="info-label">Ø§Ù„Ù…ÙˆØ¸Ù:</span>
            <span class="info-value">{{ inv.agreement.employee }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="profile-section">
        <div class="card-section-title">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
        <div class="quick-actions employee-actions">
          <a href="{% url 'finance:invoice_list' %}" class="btn btn-outline btn-sm">
            ğŸ“‹ ÙÙˆØ§ØªÙŠØ±ÙŠ
          </a>
          {% if inv.agreement %}
            <a href="{% url 'marketplace:request_detail' inv.agreement.request_id %}" class="btn btn-outline btn-sm">
              ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
            </a>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}
