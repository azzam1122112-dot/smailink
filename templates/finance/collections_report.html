{# finance/templates/finance/collections_report.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}تقرير التحصيل{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" dir="rtl">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
    <div>
      <h1 class="text-2xl font-extrabold">تقرير التحصيل</h1>
      <p class="text-sm text-gray-600 mt-1">فلترة حسب الحالة/الطريقة/الفترة، مع إحصاءات حسب طريقة الدفع.</p>
    </div>

    <form method="get" class="bg-white p-3 rounded-2xl shadow">
      <div class="grid grid-cols-2 md:grid-cols-8 gap-2">
        <div>
          <label class="text-xs text-gray-500">النطاق</label>
          <select name="period" class="w-full border rounded-lg px-3 py-2">
            <option value="" {% if not period %}selected{% endif %}>آخر 30 يومًا</option>
            <option value="today" {% if period == "today" %}selected{% endif %}>اليوم</option>
            <option value="7d" {% if period == "7d" %}selected{% endif %}>آخر 7 أيام</option>
            <option value="30d" {% if period == "30d" %}selected{% endif %}>آخر 30 يومًا</option>
            <option value="custom" {% if period == "custom" %}selected{% endif %}>مخصص</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">من</label>
          <input type="date" name="from" value="{{ from }}" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="text-xs text-gray-500">إلى</label>
          <input type="date" name="to" value="{{ to }}" class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="text-xs text-gray-500">الحالة</label>
          <select name="status" class="w-full border rounded-lg px-3 py-2">
            <option value="" {% if not status_q %}selected{% endif %}>الكل</option>
            <option value="unpaid" {% if status_q == "unpaid" %}selected{% endif %}>غير مدفوعة</option>
            <option value="paid" {% if status_q == "paid" %}selected{% endif %}>مدفوعة</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-500">الطريقة</label>
          <select name="method" class="w-full border rounded-lg px-3 py-2">
            <option value="" {% if not method_q %}selected{% endif %}>الكل</option>
            {% for m in methods %}
            <option value="{{ m }}" {% if method_q == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="md:col-span-3">
          <label class="text-xs text-gray-500">بحث</label>
          <input type="text" name="q" value="{{ q }}" class="w-full border rounded-lg px-3 py-2" placeholder="رقم طلب/اتفاقية/مرجع">
        </div>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <button class="btn btn-sm">تطبيق</button>
        <a href="{% url 'finance:export_invoices_csv' %}?period={{ period }}&from={{ from }}&to={{ to }}&status={{ status_q }}&method={{ method_q }}&q={{ q }}" class="btn btn-sm">تصدير CSV</a>
      </div>
    </form>
  </div>

  <div class="mb-4 rounded-2xl bg-white p-4 shadow">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
      <div><span class="text-gray-500">الإجمالي:</span> {{ totals.total|default:0|floatformat:2 }} ريال</div>
      <div><span class="text-gray-500">مدفوع:</span> {{ totals.paid|default:0|floatformat:2 }} ريال</div>
      <div><span class="text-gray-500">غير مدفوع:</span> {{ totals.unpaid|default:0|floatformat:2 }} ريال</div>
    </div>
  </div>

  <div class="rounded-2xl bg-white p-4 shadow mb-6">
    <h2 class="font-bold mb-3">حسب طريقة الدفع</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-gray-600 border-b">
            <th class="py-2 px-3 text-right">الطريقة</th>
            <th class="py-2 px-3 text-right">عدد الفواتير</th>
            <th class="py-2 px-3 text-right">المبلغ</th>
          </tr>
        </thead>
        <tbody>
          {% if by_method %}
          {% for row in by_method %}
          <tr class="border-b">
            <td class="py-2 px-3">{% if row.method %}{{ row.method }}{% else %}—{% endif %}</td>
            <td class="py-2 px-3">{{ row.cnt }}</td>
            <td class="py-2 px-3">{{ row.amt|floatformat:2 }}</td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="3" class="py-4 px-3 text-gray-500">لا توجد بيانات.</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="overflow-x-auto rounded-2xl shadow bg-white">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-gray-600 border-b">
          <th class="py-2 px-3 text-right">#</th>
          <th class="py-2 px-3 text-right">الاتفاقية/الطلب</th>
          <th class="py-2 px-3 text-right">المبلغ</th>
          <th class="py-2 px-3 text-right">الحالة</th>
          <th class="py-2 px-3 text-right">الطريقة</th>
          <th class="py-2 px-3 text-right">المرجع</th>
          <th class="py-2 px-3 text-right">الإصدار</th>
          <th class="py-2 px-3 text-right">السداد</th>
        </tr>
      </thead>
      <tbody>
        {% if invoices %}
        {% for inv in invoices %}
        <tr class="border-b">
          <td class="py-2 px-3">#{{ inv.id }}</td>
          <td class="py-2 px-3">A{{ inv.agreement_id }}{% if inv.agreement and inv.agreement.request_id %} / R{{ inv.agreement.request_id }}{% endif %}</td>
          <td class="py-2 px-3">{{ inv.total_amount|floatformat:2 }}</td>
          <td class="py-2 px-3">{{ inv.get_status_display }}</td>
          <td class="py-2 px-3">{% if inv.method %}{{ inv.method }}{% else %}—{% endif %}</td>
          <td class="py-2 px-3">{% if inv.ref_code %}{{ inv.ref_code }}{% else %}—{% endif %}</td>
          <td class="py-2 px-3">{% if inv.issued_at %}{{ inv.issued_at|date:"Y-m-d" }}{% else %}—{% endif %}</td>
          <td class="py-2 px-3">{% if inv.paid_at %}{{ inv.paid_at|date:"Y-m-d" }}{% else %}—{% endif %}</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="8" class="py-4 px-3 text-gray-500">لا توجد فواتير ضمن المرشحات الحالية.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
