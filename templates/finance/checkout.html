{# finance/templates/finance/checkout.html #}
{% extends "base.html" %}
{% load humanize %}

{% block title %}ุงูุฏูุน ููุงุชูุงููุฉ A{{ agreement.id }}{% endblock %}

{% block content %}
<section class="page-section checkout-page" dir="rtl">
  <div class="container">

    {# ===== ุฑุฃุณ ุงูุตูุญุฉ ===== #}
    <div class="section-header" style="text-align: right; margin-bottom: 2rem;">
      <div class="section-badge">๐ณ ุงูุฏูุน ููุงุชูุงููุฉ</div>
      <h1 class="section-title">ุงูุฏูุน ููุงุชูุงููุฉ A{{ agreement.id }}</h1>
      <p class="section-description">
        R{{ agreement.request_id }} โ ุงูููุธู:
        {% if agreement.employee %}{{ agreement.employee }}{% else %}โ{% endif %}
      </p>
    </div>

    {# ===== ุจุทุงูุฉ ุงููุจูุบ ุงูุฑุฆูุณู ===== #}
    <div class="profile-section" style="background: linear-gradient(135deg, var(--primary-600) 0%, #4f46e5 100%); color: white; margin-bottom: 2rem;">
      <div class="card-row" style="display: flex; align-items: center; justify-content: space-between; gap: 2rem;">
        <div style="flex: 1;">
          <div class="card-section-title" style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 0.5rem;">
            ุฅุฌูุงูู ุงููุจูุบ ุงููุณุชุญู ููุฏูุน
          </div>
          <div class="amount-display" style="font-size: 2.5rem; font-weight: 800; line-height: 1.2;">
            {{ breakdown.grand_total|default:0|floatformat:2 }}
            <span style="font-size: 1rem; font-weight: 400; opacity: 0.9;">ุฑ.ุณ</span>
          </div>
          <div class="card-section-note" style="color: rgba(255,255,255,0.8); margin-top: 0.5rem;">
            ูุดูู ูููุฉ ุงููุดุฑูุน + ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ููุท (ุงูุนูููุฉ ูุง ูุชุญูููุง ุงูุนููู)
          </div>
        </div>
        <div class="agreement-info" style="text-align: left; opacity: 0.9;">
          <div style="font-size: 0.9rem;">ุงุชูุงููุฉ ุฑูู: A{{ agreement.id }}</div>
          <div style="font-size: 0.9rem;">ุทูุจ ุฑูู: R{{ agreement.request_id }}</div>
        </div>
      </div>
    </div>

    <div class="checkout-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

      {# ===== ุจูุงูุงุช ุงูุชุญููู ุงูุจููู ููุท ===== #}
      <div class="profile-section">
        <div class="bank-info profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
          <div class="card-section-title" style="color: var(--primary-700);">๐ฆ ุจูุงูุงุช ุงูุชุญููู ุงูุจููู</div>
          <p class="card-section-note" style="margin-bottom: 1rem;">
            ุงูุฑุฌุงุก ุงูุชุญููู ุฅูู ุงูุญุณุงุจ ุงูุจููู ุงูููุถุญ ุฃุฏูุงู ุซู ุฅุฏุฎุงู ูุฑุฌุน ุงูุชุญููู ุงูุจููู ูู ุงููููุฐุฌ ุงููุฌุงูุฑ.
          </p>
          <div class="bank-details">
            <div class="bank-detail">
              <span class="bank-label">ุงูุจูู:</span>
              <span class="bank-value">{{ BANK_NAME }}</span>
            </div>
            <div class="bank-detail">
              <span class="bank-label">ุงูุงุณู:</span>
              <span class="bank-value">{{ BANK_ACCOUNT_NAME }}</span>
            </div>
            <div class="bank-detail">
              <span class="bank-label">IBAN:</span>
              <span class="bank-value">
                {% if BANK_IBAN_MASKED %}
                  {{ BANK_IBAN_MASKED }}
                {% else %}
                  {{ BANK_IBAN }}
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </div>

      {# ===== ุงููุงุชูุฑุฉ ููุฑุฌุน ุงูุชุญููู ===== #}
      <div class="profile-section">
        <div class="card-section-title">๐งพ ุงููุงุชูุฑุฉ</div>

        <div class="invoice-info">
          <div class="info-row">
            <span class="info-label">ุฑูู ุงููุงุชูุฑุฉ:</span>
            <span class="info-value">#{{ invoice.id }}</span>
          </div>

          <div class="info-row">
            <span class="info-label">ุงูุญุงูุฉ:</span>
            <span class="info-value">
              <span class="badge {% if invoice.is_paid %}badge-verified{% else %}badge-pending{% endif %}">
                {{ invoice.get_status_display }}
              </span>
            </span>
          </div>

          <div class="info-row">
            <span class="info-label">ุงูุฅุฌูุงูู ุงููุณุชุญู ูู ุงูุนููู:</span>
            <span class="info-value" style="font-weight: 700; color: var(--primary-600);">
              {{ breakdown.grand_total|default:0|floatformat:2 }} ุฑ.ุณ
            </span>
          </div>
        </div>

        {% if invoice.is_paid %}
          <div class="payment-success profile-section" style="background: var(--primary-50); border-color: var(--primary-200); margin-top: 1.5rem;">
            <div class="success-content" style="text-align: center; padding: 1.5rem;">
              <div class="success-icon" style="font-size: 3rem; margin-bottom: 1rem;">โ</div>
              <h3 class="card-section-title" style="color: var(--primary-700); margin-bottom: 0.5rem;">
                ุชู ุณุฏุงุฏ ุงููุงุชูุฑุฉ
              </h3>
              <p class="card-section-note">
                ุดูุฑูุง ูุชุนุงููู ๐ฟ ุณูุชู ูุชุงุจุนุฉ ุงูุทูุจ ูุน ุงูููุธู ุงููุณูุฏ.
              </p>
            </div>
          </div>
        {% elif invoice.paid_ref %}
          <div class="payment-pending profile-section" style="background: #fffbeb; border-color: #d97706; margin-top: 1.5rem;">
            <div class="pending-content" style="text-align: center; padding: 1.5rem;">
              <div class="pending-icon" style="font-size: 3rem; margin-bottom: 1rem;">โณ</div>
              <h3 class="card-section-title" style="color: #d97706; margin-bottom: 0.5rem;">
                ููุฏ ุงููุฑุงุฌุนุฉ
              </h3>
              <p class="card-section-note">
                ุชู ุฅุฑุณุงู ูุฑุฌุน ุงูุชุญููู ({{ invoice.paid_ref }}) ูุฌุงุฑู ุงูุชุญูู ููู.
                ูุง ุญุงุฌุฉ ูุฅุฑุณุงูู ูุฑุฉ ุฃุฎุฑู.
              </p>
              {% if invoice.receipt_image %}
              <div style="margin-top: 1rem;">
                  <a href="{{ invoice.receipt_image.url }}" target="_blank" class="btn btn-outline btn-sm">
                      ๐ ุนุฑุถ ุงูุฅูุตุงู ุงููุฑูู
                  </a>
              </div>
              {% endif %}
            </div>
          </div>
        {% else %}
          <form method="post"
                action="{% url 'finance:confirm_bank_transfer' invoice.id %}"
                class="transfer-form"
                id="transferForm"
                enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-field">
              <label class="form-label">๐ ูุฑุฌุน ุงูุชุญููู ุงูุจููู</label>
              <input type="text"
                     name="paid_ref"
                     minlength="4"
                     class="input"
                     placeholder="ุฃุฏุฎู ุงููุฑุฌุน ุงูุจููู ููุง ูุธูุฑ ูู ุฅูุตุงู ุงูุจูู"
                     required
                     id="paidRefInput">
              <p class="field-hint">
                ูุซุงู: ุฑูู ุงูุนูููุฉ ุฃู ุฑูู ุงูุชุญููู ุงูุธุงูุฑ ูู ุงูุฅูุตุงู ุงูุจููู
              </p>
            </div>

            <div class="receipt-section profile-section" style="background: var(--dark-50); margin-top: 1.5rem;">
              <div class="card-section-title">๐ ุฅูุตุงู ุงูุชุญููู ุงูุจููู</div>
              <p class="card-section-note" style="margin-bottom: 1rem;">
                ูุฑุฌู ุฑูุน ุตูุฑุฉ ูุงุถุญุฉ ูุฅูุตุงู ุงูุชุญููู ุงูุจููู ูุชุณุฑูุน ุนูููุฉ ุงูุชุฃููุฏ.
              </p>
              <div class="upload-container" style="text-align: center; padding: 1.5rem; border: 2px dashed var(--dark-300); border-radius: var(--radius-lg); background: var(--white);">
                <input type="file" name="receipt_image" id="receiptImageInput" accept="image/*" class="d-none" onchange="previewReceipt(this)">
                <label for="receiptImageInput" style="cursor: pointer; width: 100%; height: 100%; display: block;">
                    <div id="uploadPlaceholder">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">๐ค</div>
                        <div style="color: var(--dark-500); font-size: 0.9rem;">ุงุถุบุท ููุง ูุฑูุน ุตูุฑุฉ ุงูุฅูุตุงู</div>
                    </div>
                    <div id="receiptPreview" style="display: none;">
                        <img id="previewImg" src="" alt="Receipt Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="color: var(--primary-600); font-size: 0.9rem;">ุชู ุงุฎุชูุงุฑ ุงูุตูุฑุฉ (ุงุถุบุท ููุชุบููุฑ)</div>
                    </div>
                </label>
              </div>
            </div>

            <div class="form-actions" style="margin-top: 1.5rem;">
              <button type="submit" class="btn btn-primary" style="width: 100%;" id="submitBtn">
                ๐จ ุฅุฑุณุงู ูุฑุฌุน ุงูุชุญููู ููุชุฃููุฏ
              </button>
            </div>
          </form>
        {% endif %}
      </div>

    </div>

    <div class="profile-section" style="background: var(--secondary-50); border-color: var(--secondary-200); margin-top: 2rem;">
      <div class="card-section-title" style="color: var(--secondary-700);">๐ก ุชูููุญุงุช ูููุฉ</div>
      <div class="tips-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <div class="tip-item">
          <div class="tip-icon">โฑ๏ธ</div>
          <div class="tip-content">
            <div class="tip-title">ุงููุนุงูุฌุฉ ุงูุณุฑูุนุฉ</div>
            <div class="tip-text">ุณูุชู ุชุฃููุฏ ุงูุชุญููู ุฎูุงู 24 ุณุงุนุฉ ุนูู</div>
          </div>
        </div>
        <div class="tip-item">
          <div class="tip-icon">๐</div>
          <div class="tip-content">
            <div class="tip-title">ุฏูุน ุขูู</div>
            <div class="tip-text">ุฌููุน ุงูุชุญูููุงุช ุนุจุฑ ูููุงุช ุจูููุฉ ุขููุฉ</div>
          </div>
        </div>
        <div class="tip-item">
          <div class="tip-icon">๐</div>
          <div class="tip-content">
            <div class="tip-title">ุงูุฏุนู ุงูููู</div>
            <div class="tip-text">ูููุณุงุนุฏุฉุ ุฑุงุณููุง ุนูู support@samilink.sa</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script>
  (function () {
    if (typeof initScrollReveal === 'function') {
      initScrollReveal();
    }

    const transferForm = document.getElementById('transferForm');
    const paidRefInput = document.getElementById('paidRefInput');
    const submitBtn = document.getElementById('submitBtn');

    if (transferForm && paidRefInput) {
      paidRefInput.addEventListener('input', function() {
        if (this.value.length >= 4) {
          this.style.borderColor = 'var(--primary-500)';
          this.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.1)';
        } else {
          this.style.borderColor = '';
          this.style.boxShadow = '';
        }
      });

      transferForm.addEventListener('submit', function(e) {
        const refValue = paidRefInput.value.trim();
        if (refValue.length < 4) {
          e.preventDefault();
          if (typeof showToast === 'function') {
            showToast('ูุฑุฌู ุฅุฏุฎุงู ูุฑุฌุน ุชุญููู ุตุญูุญ (4 ุฃุญุฑู ุนูู ุงูุฃูู)', 'error');
          } else {
            alert('ูุฑุฌู ุฅุฏุฎุงู ูุฑุฌุน ุชุญููู ุตุญูุญ (4 ุฃุญุฑู ุนูู ุงูุฃูู)');
          }
          paidRefInput.focus();
          return false;
        }

        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'โณ ุฌุงุฑู ุงูุฅุฑุณุงู...';
        }

        if (typeof showToast === 'function') {
          showToast('ุฌุงุฑู ุฅุฑุณุงู ูุฑุฌุน ุงูุชุญููู ููุชุฃููุฏ...', 'info');
        }
      });
    }

    const bankDetails = document.querySelectorAll('.bank-detail');
    bankDetails.forEach(detail => {
      detail.style.cursor = 'pointer';
      detail.addEventListener('click', function() {
        const textToCopy = this.querySelector('.bank-value').textContent;
        navigator.clipboard.writeText(textToCopy).then(() => {
          if (typeof showToast === 'function') {
            showToast('ุชู ูุณุฎ ุงููุนูููุงุช', 'success');
          }
        });
      });
    });
  })();

  function previewReceipt(input) {
    const placeholder = document.getElementById('uploadPlaceholder');
    const preview = document.getElementById('receiptPreview');
    const previewImg = document.getElementById('previewImg');

    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            placeholder.style.display = 'none';
            preview.style.display = 'block';
        }
        
        reader.readAsDataURL(input.files[0]);
    }
  }
  </script>
{% endblock %}
