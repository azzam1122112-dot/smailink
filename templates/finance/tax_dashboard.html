{% extends "base.html" %}
{% load humanize %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨{% endblock %}

{% block content %}
<section class="page-section" dir="rtl">
  <div class="container mx-auto px-4 py-6">

    {# ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== #}
    <div class="mb-6">
      <div class="flex items-center gap-2">
        <div class="badge badge-default">ğŸ§¾ VAT</div>
        <h1 class="text-2xl md:text-3xl font-extrabold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨ (VAT)</h1>
      </div>
      <p class="text-sm text-gray-600 mt-1">
        Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ±ÙŠØ¯ ÙˆÙÙ‚ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        (Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø¹Ù„Ù‰ P ÙÙ‚Ø· â€” ÙˆØ¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø© Ù„Ø§ ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„).
      </p>
    </div>

    {# ===== KPIs ===== #}
    <div class="stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="profile-section" style="background:linear-gradient(135deg,#ecfeff 0%, #fff 100%);">
        <div class="card-section-title">âœ… VAT Ù…ÙØ­ØµÙ‘Ù„Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="stat-value" style="color:#0e7490;font-size:1.8rem;font-weight:800;">
          {{ vat_collected|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
        <div class="text-xs text-gray-500 mt-1">Ù…Ù† ÙÙˆØ§ØªÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
      </div>

      <div class="profile-section" style="background:linear-gradient(135deg,#fef3c7 0%, #fff 100%);">
        <div class="card-section-title">â³ VAT ØºÙŠØ± Ù…ÙØ­ØµÙ‘Ù„Ø© Ø¨Ø¹Ø¯</div>
        <div class="stat-value" style="color:#b45309;font-size:1.8rem;font-weight:800;">
          {{ vat_pending|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
        <div class="text-xs text-gray-500 mt-1">Ù…Ù† ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
      </div>

      <div class="profile-section" style="background:linear-gradient(135deg,#ede9fe 0%, #fff 100%);">
        <div class="card-section-title">ğŸ›ï¸ VAT Ù…ÙÙˆØ±Ù‘Ø¯Ø©</div>
        <div class="stat-value" style="color:#6d28d9;font-size:1.8rem;font-weight:800;">
          {{ remitted_total|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
        <div class="text-xs text-gray-500 mt-1">ØªÙˆØ±ÙŠØ¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>
      </div>

      <div class="profile-section" style="background:linear-gradient(135deg,#dcfce7 0%, #fff 100%);">
        <div class="card-section-title">ğŸ“¦ Ù…Ø®Ø²Ù† Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
        <div class="stat-value" style="color:#15803d;font-size:1.8rem;font-weight:800;">
          {{ tax_stock|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
        </div>
        <div class="text-xs text-gray-500 mt-1">VAT Ø§Ù„Ù…Ø­ØµÙ‘Ù„ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ±Ù‘Ø¯</div>
      </div>
    </div>

    {# ===== ØªÙˆØ±ÙŠØ¯ Ø¶Ø±ÙŠØ¨Ø© Ø¬Ø¯ÙŠØ¯ ===== #}
    <div class="profile-section mt-6">
      <details class="rounded-2xl bg-white shadow p-4" {% if remit_form.errors %}open{% endif %}>
        <summary class="cursor-pointer font-bold text-base flex items-center gap-2">
          â• ØªÙˆØ±ÙŠØ¯ Ø¶Ø±ÙŠØ¨Ø© Ø¬Ø¯ÙŠØ¯
          <span class="text-xs text-gray-500 font-normal">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ØªÙˆØ±ÙŠØ¯ VAT Ù„Ù„Ù…Ø®Ø²Ù†</span>
        </summary>

        <form method="post" class="mt-4 grid grid-cols-1 md:grid-cols-5 gap-3">
          {% csrf_token %}

          {% if remit_form.non_field_errors %}
            <div class="md:col-span-5">
              <div class="p-3 rounded-xl bg-red-50 text-red-700 text-sm">
                {{ remit_form.non_field_errors }}
              </div>
            </div>
          {% endif %}

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">Ø§Ù„Ù…Ø¨Ù„Øº</label>
            {{ remit_form.amount }}
            {% if remit_form.amount.errors %}
              <div class="text-xs text-red-600 mt-1">{{ remit_form.amount.errors }}</div>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            {{ remit_form.period_from }}
            {% if remit_form.period_from.errors %}
              <div class="text-xs text-red-600 mt-1">{{ remit_form.period_from.errors }}</div>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            {{ remit_form.period_to }}
            {% if remit_form.period_to.errors %}
              <div class="text-xs text-red-600 mt-1">{{ remit_form.period_to.errors }}</div>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªÙˆØ±ÙŠØ¯</label>
            {{ remit_form.ref_code }}
            {% if remit_form.ref_code.errors %}
              <div class="text-xs text-red-600 mt-1">{{ remit_form.ref_code.errors }}</div>
            {% endif %}
          </div>

          <div class="md:col-span-3">
            <label class="block text-sm font-semibold mb-1">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            {{ remit_form.note }}
            {% if remit_form.note.errors %}
              <div class="text-xs text-red-600 mt-1">{{ remit_form.note.errors }}</div>
            {% endif %}
          </div>

          <div class="md:col-span-2 flex items-center gap-2 mt-6">
            {{ remit_form.sent_now }}
            <label class="text-sm">{{ remit_form.sent_now.label }}</label>
          </div>

          <div class="md:col-span-5 flex justify-end mt-2">
            <button type="submit" class="btn btn-primary btn-sm">
              Ø­ÙØ¸ Ø§Ù„ØªÙˆØ±ÙŠØ¯
            </button>
          </div>
        </form>
      </details>
    </div>

    {# ===== Ø¢Ø®Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª ===== #}
    <div class="profile-section mt-6">
      <div class="card-section-title">Ø¢Ø®Ø± ØªÙˆØ±ÙŠØ¯Ø§Øª Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>

      {% if last_remittances %}
        <div class="overflow-x-auto rounded-2xl bg-white shadow mt-3">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-600 border-b">
                <th class="py-2 px-3 text-right">#</th>
                <th class="py-2 px-3 text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th class="py-2 px-3 text-right">Ø§Ù„ÙØªØ±Ø©</th>
                <th class="py-2 px-3 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th class="py-2 px-3 text-right">Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                <th class="py-2 px-3 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              </tr>
            </thead>
            <tbody>
              {% for tr in last_remittances %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-2 px-3">#{{ tr.id }}</td>
                <td class="py-2 px-3 font-semibold">{{ tr.amount|floatformat:2 }} Ø±ÙŠØ§Ù„</td>
                <td class="py-2 px-3">
                  {% if tr.period_from %}{{ tr.period_from }}{% else %}â€”{% endif %}
                  â†’
                  {% if tr.period_to %}{{ tr.period_to }}{% else %}â€”{% endif %}
                </td>
                <td class="py-2 px-3">
                  <span class="badge badge-default">{{ tr.get_status_display }}</span>
                </td>
                <td class="py-2 px-3">{{ tr.ref_code|default:"â€”" }}</td>
                <td class="py-2 px-3">{{ tr.created_at|date:"Y-m-d" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØ±ÙŠØ¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©.</p>
      {% endif %}
    </div>

    {# ===== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù„ÙƒÙ„ Ø·Ù„Ø¨/Ø§ØªÙØ§Ù‚ÙŠØ© ===== #}
    <div class="profile-section mt-6">
      <div class="flex items-center justify-between">
        <div class="card-section-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨</div>
        <div class="text-xs text-gray-500">
          * Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ = P + VAT (Ù„Ø§ ÙŠØ´Ù…Ù„ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø©)
        </div>
      </div>

      {% if rows %}
        <div class="overflow-x-auto rounded-2xl bg-white shadow mt-3">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-600 border-b">
                <th class="py-2 px-3 text-right">Ø§Ù„Ø·Ù„Ø¨</th>
                <th class="py-2 px-3 text-right">Ø§Ù„Ø§ØªÙØ§Ù‚ÙŠØ©</th>
                <th class="py-2 px-3 text-right">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th class="py-2 px-3 text-right">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ P</th>
                <th class="py-2 px-3 text-right">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµÙ‘Ø© (ØªÙØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù)</th>
                <th class="py-2 px-3 text-right">Ø§Ù„ÙˆØ¹Ø§Ø¡ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (P)</th>
                <th class="py-2 px-3 text-right">VAT</th>
                <th class="py-2 px-3 text-right">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th class="py-2 px-3 text-right">Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
                <th class="py-2 px-3 text-right">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¯Ø§Ø¯</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr class="border-b hover:bg-gray-50">
                <td class="py-2 px-3">
                  {% if r.request %}
                    #{{ r.request.id }} â€” {{ r.request.title|default:"Ø·Ù„Ø¨" }}
                  {% else %}
                    â€”
                  {% endif %}
                </td>
                <td class="py-2 px-3">#{{ r.agreement.id }}</td>
                <td class="py-2 px-3">
                  {% if r.employee %}{{ r.employee }}{% else %}â€”{% endif %}
                </td>

                {# P #}
                <td class="py-2 px-3">{{ r.P|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„</td>

                {# Fee (Ù„Ø§ ØªØ¯Ø®Ù„ ÙÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„) #}
                <td class="py-2 px-3 text-gray-700">
                  {{ r.platform_fee|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
                </td>

                {# Taxable base = P ÙÙ‚Ø· #}
                <td class="py-2 px-3">
                  {{ r.taxable|default:r.P|floatformat:2 }} Ø±ÙŠØ§Ù„
                </td>

                {# VAT #}
                <td class="py-2 px-3 font-semibold">
                  {{ r.vat_amount|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
                </td>

                {# Client total = P + VAT #}
                <td class="py-2 px-3 font-semibold">
                  {{ r.grand_total|default:0|floatformat:2 }} Ø±ÙŠØ§Ù„
                </td>

                <td class="py-2 px-3">
                  {% if r.is_paid %}
                    <span class="badge badge-verified">Ù…Ø¯ÙÙˆØ¹Ø©</span>
                  {% else %}
                    <span class="badge badge-pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</span>
                  {% endif %}
                </td>
                <td class="py-2 px-3">
                  {% if r.paid_at %}{{ r.paid_at|date:"Y-m-d" }}{% else %}â€”{% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¶Ø±ÙŠØ¨Ø© Ù„Ù„Ø¹Ø±Ø¶.</p>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
