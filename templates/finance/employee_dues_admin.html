{% extends "base.html" %}
{% load humanize %}

{% block title %}ูุณุชุญูุงุช ุงูููุธููู (ุฅุฏุงุฑุฉ){% endblock %}

{% block content %}
<section class="page-section" dir="rtl">
  <div class="container">

    {# =================== ุฑุฃุณ ุงูุตูุญุฉ =================== #}
    <div class="section-header" style="text-align:right;margin-bottom:1.5rem;">
      <div class="section-badge">๐จโ๐ป ูุณุชุญูุงุช ุงูููุธููู</div>
      <h1 class="section-title">ูุณุชุญูุงุช ุงูููุธููู (ุฅุฏุงุฑุฉ)</h1>
      <p class="section-description">
        ูุชุงุจุนุฉ ูุณุชุญูุงุช ุงูููุธููู ููุทูุจุงุช ุงูููุชููุฉ ูุงููุฏููุนุฉุ ูุน ุชุทุจูู ูุงูุฐุฉ ุฃูุงู {{ safety_days|default:3 }} ุฃูุงู
        ุชุจุฏุฃ ูู **ุชุงุฑูุฎ ุงูุชูุงู ุงููุดุฑูุน** ูุจู ุงูุตุฑู.
      </p>

      <div style="margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;">
        <a href="{% url 'finance:payouts_list' %}" class="btn btn-outline btn-sm">๐ค ุฃูุงูุฑ ุงูุตุฑู</a>
        <a href="{% url 'finance:invoice_list' %}" class="btn btn-outline btn-sm">๐งพ ุงูููุงุชูุฑ</a>
        <a href="{% url 'finance:finance_home' %}" class="btn btn-outline btn-sm">๐ฐ ููุญุฉ ุงููุงููุฉ</a>
      </div>
    </div>

    {# =================== ูุฑูุช ูุนูููุงุช ุณุฑูุนุฉ =================== #}
    <div class="stats-grid"
         style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
                gap:1rem;margin-bottom:1.25rem;">

      <div class="stat-card profile-section">
        <div class="stat-label">ุนุฏุฏ ุงูุงุชูุงููุงุช ุงููุนุฑูุถุฉ</div>
        <div class="stat-value">{{ rows|length }}</div>
        <div class="text-muted text-xs mt-1">ูุดูู ุงููุคูู ูููุฏ ุงูุงูุชุธุงุฑ ูุงููุฌููุฏ</div>
      </div>

      <div class="stat-card profile-section">
        <div class="stat-label">ูุงูุฐุฉ ุงูุฃูุงู</div>
        <div class="stat-value">{{ safety_days|default:3 }} ุฃูุงู</div>
        <div class="text-muted text-xs mt-1">ุชุจุฏุฃ ูู ุงูุชูุงู ุงููุดุฑูุน</div>
      </div>

      <div class="stat-card profile-section">
        <div class="stat-label">ุขุฎุฑ ุชุญุฏูุซ</div>
        <div class="stat-value">{{ now|date:"Y-m-d H:i" }}</div>
      </div>

      <div class="stat-card profile-section">
        <div class="stat-label">ุชูุจูู</div>
        <div class="stat-value text-sm">ุงูุตุฑู ูุชููู ุนูุฏ ุงููุฒุงุนุงุช</div>
      </div>
    </div>

    {# =================== ููุงุชุฑ ูุญูููุฉ =================== #}
    <div class="profile-section" style="padding:.75rem 1rem;margin-bottom:1rem;">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
        <span class="text-sm text-muted">ููุชุฑุฉ ุญุณุจ ุงูุงุณุชุญูุงู:</span>

        <button type="button" class="btn btn-outline btn-sm js-filter-btn" data-filter="all">ุงููู</button>
        <button type="button" class="btn btn-outline btn-sm js-filter-btn" data-filter="eligible">ูุคูู ุงูุขู</button>
        <button type="button" class="btn btn-outline btn-sm js-filter-btn" data-filter="pending">ููุฏ ุงูุงูุชุธุงุฑ</button>
        <button type="button" class="btn btn-outline btn-sm js-filter-btn" data-filter="held">ูุฌููุฏ</button>

        <div class="text-xs text-muted" id="filter-count" style="margin-right:auto;"></div>
      </div>
    </div>

    {# =================== ุฌุฏูู ุงููุณุชุญูุงุช =================== #}
    <div class="profile-section data-card">
      <div class="data-card-header"
           style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
        <h3 class="card-section-title">๐ ุงูุงุชูุงููุงุช ุงููุณุชุญูุฉ</h3>
        <div class="text-muted text-xs">ุขุฎุฑ ุชุญุฏูุซ: {{ now|date:"Y-m-d H:i" }}</div>
      </div>

      <div class="table-wrapper">
        <table class="table table-clean">
          <thead>
            <tr>
              <th>ุงูุงุชูุงููุฉ / ุงูุทูุจ</th>
              <th>ุงูููุธู</th>
              <th>ุตุงูู ุงูููุธู</th>
              <th>ูุงุชูุฑุฉ ูุฏููุนุฉ</th>
              <th>ุงูุชูุงู ุงููุดุฑูุน</th>
              <th>ุขุฎุฑ ุณุฏุงุฏ</th>
              <th>ุงูุงุณุชุญูุงู</th>
              <th>ุญุงูุฉ ุงูุตุฑู</th>
              <th>ุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>

          <tbody>
            {% for row in rows %}
              {% with ag=row.agreement req=row.request inv=row.invoice_to_link payout=row.payout %}
              <tr class="scroll-reveal due-row"
                  data-state="{% if row.held_reason %}held{% elif row.eligible_now %}eligible{% else %}pending{% endif %}">

                {# ุงูุงุชูุงููุฉ/ุงูุทูุจ #}
                <td>
                  <div style="font-weight:700;">
                    Agreement #{{ ag.id }}
                    {% if req %}
                      โ ุทูุจ #{{ req.id }} {{ req.title }}
                    {% endif %}
                  </div>

                  {% if req %}
                    <div class="text-muted text-xs mt-1">
                      ุญุงูุฉ ุงูุทูุจ: {{ req.get_status_display|default:req.status }}
                    </div>
                  {% endif %}
                </td>

                {# ุงูููุธู #}
                <td>
                  <div style="font-weight:700;">{{ row.employee }}</div>
                </td>

                {# ุตุงูู ุงูููุธู #}
                <td class="value-strong">
                  {{ row.net_for_employee|default:0|floatformat:2 }} ุฑ.ุณ
                </td>

                {# ูุงุชูุฑุฉ ูุฏููุนุฉ #}
                <td>
                  {% if inv %}
                    <div style="font-weight:700;">#{{ inv.id }}</div>
                    <div class="text-muted text-xs">ูุฏููุนุฉ</div>
                  {% else %}
                    <span class="badge badge-default">ูุง ุชูุฌุฏ</span>
                  {% endif %}
                </td>

                {# ุงูุชูุงู ุงููุดุฑูุน #}
                <td>
                  {% if row.completed_at %}
                    {{ row.completed_at|date:"Y-m-d H:i" }}
                  {% else %}
                    โ
                  {% endif %}
                </td>

                {# ุขุฎุฑ ุณุฏุงุฏ #}
                <td>
                  {% if row.last_paid_at %}
                    {{ row.last_paid_at|date:"Y-m-d H:i" }}
                  {% else %}
                    โ
                  {% endif %}
                </td>

                {# ุงูุงุณุชุญูุงู #}
                <td>
                  {% if row.held_reason %}
                    <span class="badge badge-rejected">ูุฌููุฏ</span>
                    <div class="text-muted text-xs mt-1">{{ row.held_reason }}</div>
                  {% else %}
                    {% if row.eligible_now %}
                      <span class="badge badge-verified">ูุคูู ููุตุฑู ุงูุขู</span>
                    {% else %}
                      <span class="badge badge-pending">ููุฏ ุงูุงูุชุธุงุฑ</span>
                      {% if row.ready_at %}
                        <div class="text-muted text-xs mt-1">
                          ูุชุงุญ ูู {{ row.ready_at|date:"Y-m-d H:i" }}
                        </div>
                      {% endif %}
                    {% endif %}
                  {% endif %}
                </td>

                {# ุญุงูุฉ ุงูุตุฑู #}
                <td>
                  {% if payout %}
                    {% if payout.status == 'paid' %}
                      <span class="badge badge-verified">ูุฏููุน</span>
                      <div class="text-muted text-xs mt-1">Payout #{{ payout.id }}</div>
                    {% elif payout.status == 'pending' %}
                      <span class="badge badge-pending">ุจุงูุชุธุงุฑ ุงูุตุฑู</span>
                      <div class="text-muted text-xs mt-1">Payout #{{ payout.id }}</div>
                    {% else %}
                      <span class="badge badge-default">
                        {{ payout.get_status_display|default:payout.status }}
                      </span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-default">ูุง ููุฌุฏ ุฃูุฑ ุตุฑู</span>
                  {% endif %}
                </td>

                {# ุฅุฌุฑุงุกุงุช #}
                <td style="white-space:nowrap;">
                  <a href="{% url 'finance:payouts_list' %}?agreement={{ ag.id }}"
                     class="btn btn-outline btn-sm">
                    ๐ ุงูุตุฑููุงุช
                  </a>

                  {% if not payout %}
                    {% if row.eligible_now %}
                      <form method="post" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="agreement_id" value="{{ ag.id }}">
                        <button type="submit" class="btn btn-primary btn-sm">
                          โ ุฅูุดุงุก ุฃูุฑ ุตุฑู
                        </button>
                      </form>
                    {% else %}
                      <button type="button" class="btn btn-outline btn-sm" disabled>
                        โณ ุบูุฑ ูุคูู ุจุนุฏ
                      </button>
                    {% endif %}
                  {% endif %}
                </td>

              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted" style="padding:2.5rem;">
                  <div class="text-4xl mb-2 opacity-40">๐งพ</div>
                  ูุง ุชูุฌุฏ ุงุชูุงููุงุช ูุณุชุญูุฉ ููุนุฑุถ ุญุงูููุง.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>

{# =================== ููุชุฑุฉ ูุญููุฉ ุจุฏูู ุฅุนุงุฏุฉ ุชุญููู =================== #}
<script>
(function () {
  const rows = Array.from(document.querySelectorAll("tr.due-row"));
  const btns = Array.from(document.querySelectorAll(".js-filter-btn"));
  const countEl = document.getElementById("filter-count");

  function applyFilter(filter) {
    let visible = 0;

    rows.forEach(tr => {
      const state = tr.getAttribute("data-state");
      const show = filter === "all" || state === filter;
      tr.style.display = show ? "" : "none";
      if (show) visible++;
    });

    if (countEl) {
      countEl.textContent = "ุงููุนุฑูุถ: " + visible + " ูู " + rows.length;
    }

    btns.forEach(b => {
      const isActive = b.getAttribute("data-filter") === filter;
      b.classList.toggle("btn-primary", isActive);
      b.classList.toggle("btn-outline", !isActive);
    });
  }

  applyFilter("all");

  btns.forEach(b => {
    b.addEventListener("click", () => applyFilter(b.getAttribute("data-filter")));
  });
})();
</script>
{% endblock %}
