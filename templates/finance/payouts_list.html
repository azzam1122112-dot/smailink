{% extends "base.html" %}
{% load humanize %}

{% block title %}ุตุฑููุงุช ุงูููุธููู{% endblock %}

{% block content %}
<section class="page-section" dir="rtl">
  <div class="container mx-auto px-4 py-6">

    <div class="mb-6">
      <div class="section-badge">๐ท Payouts</div>
      <h1 class="text-2xl md:text-3xl font-extrabold mt-2">ุตุฑููุงุช ุงูููุธููู</h1>
      <p class="text-sm text-gray-600 mt-1">
        ูุชุงุจุนุฉ ุฃูุงูุฑ ุงูุตุฑู ุญุณุจ ุงูุณูุงุณุฉ: ุงูุทูุจุงุช ุงูููุชููุฉ ููุท ูุตุงูู ุงูููุธู = P - ุนูููุฉ ุงูููุตุฉ.
      </p>
    </div>

    {# ===== KPIs ===== #}
    <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;">
      <div class="profile-section">
        <div class="card-section-title">๐ ุฅุฌูุงูู ุงูุตุฑููุงุช</div>
        <div class="stat-value">{{ totals.total|default:0|floatformat:2 }} ุฑูุงู</div>
        <div class="card-section-note">ุนุฏุฏ ุงูุฃูุงูุฑ: {{ totals.count|default:0 }}</div>
      </div>
      <div class="profile-section" style="background:linear-gradient(135deg,#fef3c7 0%, #fff 100%);">
        <div class="card-section-title">โณ ูุนูููุฉ</div>
        <div class="stat-value">{{ totals.pending|default:0|floatformat:2 }} ุฑูุงู</div>
      </div>
      <div class="profile-section" style="background:linear-gradient(135deg,#dcfce7 0%, #fff 100%);">
        <div class="card-section-title">โ ุชู ุตุฑููุง</div>
        <div class="stat-value">{{ totals.paid|default:0|floatformat:2 }} ุฑูุงู</div>
      </div>
      <div class="profile-section" style="background:linear-gradient(135deg,#fee2e2 0%, #fff 100%);">
        <div class="card-section-title">๐ซ ููุบุงุฉ</div>
        <div class="stat-value">{{ totals.cancelled|default:0|floatformat:2 }} ุฑูุงู</div>
      </div>
    </div>

    {# ===== ููุงุชุฑ ===== #}
    <div class="profile-section mt-6">
      <div class="card-section-title">ููุชุฑุฉ ูุจุญุซ</div>

      <form method="get" class="mt-3" style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;">
        <select name="status" class="input input-sm w-40">
          <option value="pending" {% if status_q == 'pending' %}selected{% endif %}>ูุนููุฉ</option>
          <option value="paid" {% if status_q == 'paid' %}selected{% endif %}>ูุฏููุนุฉ</option>
          <option value="cancelled" {% if status_q == 'cancelled' %}selected{% endif %}>ููุบุงุฉ</option>
          <option value="all" {% if status_q == 'all' %}selected{% endif %}>ุงููู</option>
        </select>

        <input name="q" value="{{ q }}" class="input input-sm flex-1 min-w-[200px]" placeholder="ุจุญุซ ุจุฑูู ุทูุจ/ุงุชูุงููุฉ/ููุธู">

        <select name="period" class="input input-sm w-40">
          <option value="" {% if not period %}selected{% endif %}>ุขุฎุฑ 30 ููู</option>
          <option value="today" {% if period == 'today' %}selected{% endif %}>ุงูููู</option>
          <option value="7d" {% if period == '7d' %}selected{% endif %}>ุขุฎุฑ 7 ุฃูุงู</option>
          <option value="30d" {% if period == '30d' %}selected{% endif %}>ุขุฎุฑ 30 ููู</option>
          <option value="custom" {% if period == 'custom' %}selected{% endif %}>ูุฎุตุต</option>
        </select>

        <input type="date" name="from" value="{{ from }}" class="input input-sm w-44">
        <input type="date" name="to" value="{{ to }}" class="input input-sm w-44">

        <button class="btn btn-primary btn-sm" type="submit">ุชุทุจูู</button>
        <a href="{% url 'finance:payouts_list' %}" class="btn btn-outline btn-sm">ุฅุนุงุฏุฉ ุถุจุท</a>
      </form>
    </div>

    {# ===== ุฌุฏูู ุงูุตุฑููุงุช ===== #}
    <div class="profile-section mt-6">
      <div class="card-section-title">ูุงุฆูุฉ ุงูุตุฑููุงุช</div>

      {% if payouts %}
        <div class="overflow-x-auto rounded-2xl bg-white shadow mt-3">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-600 border-b">
                <th class="py-2 px-3 text-right">#</th>
                <th class="py-2 px-3 text-right">ุงูููุธู</th>
                <th class="py-2 px-3 text-right">ุงูุทูุจ</th>
                <th class="py-2 px-3 text-right">ุงูุงุชูุงููุฉ</th>
                <th class="py-2 px-3 text-right">ุงูุตุงูู</th>
                <th class="py-2 px-3 text-right">ุงูุญุงูุฉ</th>
                <th class="py-2 px-3 text-right">ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                <th class="py-2 px-3 text-right">ุชุงุฑูุฎ ุงูุตุฑู</th>
                <th class="py-2 px-3 text-right">ุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody>
              {% for p in payouts %}
                <tr class="border-b hover:bg-gray-50">
                  <td class="py-2 px-3">#{{ p.pk }}</td>
                  <td class="py-2 px-3">{{ p.employee }}</td>

                  <td class="py-2 px-3">
                    {% if p.agreement and p.agreement.request %}
                      <a href="{% url 'marketplace:request_detail' p.agreement.request.pk %}">
                        #{{ p.agreement.request.pk }}
                      </a>
                    {% else %}
                      โ
                    {% endif %}
                  </td>

                  <td class="py-2 px-3">
                    {% if p.agreement %}
                      #{{ p.agreement.pk }}
                    {% else %}
                      โ
                    {% endif %}
                  </td>

                  <td class="py-2 px-3 font-semibold">{{ p.amount|floatformat:2 }} ุฑูุงู</td>

                  <td class="py-2 px-3">
                    <span class="badge badge-default">{{ p.get_status_display }}</span>
                  </td>

                  <td class="py-2 px-3">{{ p.issued_at|date:"Y-m-d" }}</td>
                  <td class="py-2 px-3">
                    {% if p.paid_at %}{{ p.paid_at|date:"Y-m-d" }}{% else %}โ{% endif %}
                  </td>

                  <td class="py-2 px-3">
                    {% if p.status == 'pending' %}
                      <form method="post" action="{% url 'finance:mark_payout_paid' p.pk %}">
                        {% csrf_token %}
                        <div style="display:flex;flex-wrap:wrap;gap:.25rem;align-items:center;">
                          <input name="method" class="input input-sm w-28" placeholder="ุทุฑููุฉ">
                          <input name="ref_code" class="input input-sm w-36" placeholder="ูุฑุฌุน">
                          <button class="btn btn-primary btn-sm" type="submit">ูุณู ููุฏููุน</button>
                        </div>
                      </form>
                    {% else %}
                      โ
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">ูุง ุชูุฌุฏ ุตุฑููุงุช ููุนุฑุถ.</p>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
