{# dashboard/templates/dashboard/admin_dashboard.html #}
{% extends "dashboard/base_admin.html" %}
{% load humanize %}

{% block title %}لوحة تحكم المدير{% endblock %}

{% block page_header %}
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4" dir="rtl">
  <div>
    <h1 class="text-2xl md:text-3xl font-extrabورد mb-1">لوحة تحكم المدير</h1>
    <p class="lbl">نظرة عامة سريعة على النظام.</p>
  </div>

  <form method="get" class="card" style="padding:.7rem 1rem">
    <div class="flex items-end gap-3">
      <div>
        <div class="lbl">من</div>
  <input class="card" style="padding:.45rem .7rem" type="date" name="from" value="{{ from|date:'Y-m-d' }}">
      </div>
      <div>
        <div class="lbl">إلى</div>
  <input class="card" style="padding:.45rem .7rem" type="date" name="to" value="{{ to|date:'Y-m-d' }}">
      </div>
      <button class="btn btn-gray" type="submit"><i class="fa fa-filter"></i><span>تصفية</span></button>
    </div>
  </form>
</div>
{% endblock %}

{% block content %}
{# روابط احتياطية آمنة #}
{% url 'marketplace:request_list' as req_list_url %}
{% url 'finance:invoice_list' as inv_list_url %}
{% url 'disputes:list' as disputes_list_url %}
{% url 'agreements:list' as agreements_list_url %}
{% url 'accounts:user_list' as users_list_url %}
{% url 'marketplace:offers_list' as offers_list_url %}

{# تنبيهات تشغيلية #}
{% if ops_alerts %}
  <div class="card mb-4">
    <div class="flex flex-wrap gap-2">
      {% for a in ops_alerts %}
        <span class="card" style="border-color:#fed7aa;background:#fff7ed">{{ a }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

{# أزرار سريعة (fallback مباشر بدون firstof/as) #}
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 mb-4">
  {% if urls.invoices|default:inv_list_url %}
    <a class="btn btn-green w-full justify-center" href="{{ urls.invoices|default:inv_list_url }}"><i class="fa fa-receipt"></i><span>الفواتير</span></a>
  {% endif %}
  {% if urls.requests|default:req_list_url %}
    <a class="btn btn-blue w-full justify-center" href="{{ urls.requests|default:req_list_url }}"><i class="fa fa-list"></i><span>الطلبات</span></a>
  {% endif %}
  {% if urls.agreements|default:agreements_list_url %}
    <a class="btn btn-purple w-full justify-center" href="{{ urls.agreements|default:agreements_list_url }}"><i class="fa fa-file-signature"></i><span>الاتفاقيات</span></a>
  {% endif %}
  {% if urls.disputes|default:disputes_list_url %}
    <a class="btn btn-rose w-full justify-center" href="{{ urls.disputes|default:disputes_list_url }}"><i class="fa fa-scale-balanced"></i><span>النزاعات</span></a>
  {% endif %}
  {% if urls.users|default:users_list_url %}
    <a class="btn btn-gray w-full justify-center" href="{{ urls.users|default:users_list_url }}"><i class="fa fa-users"></i><span>المستخدمون</span></a>
  {% endif %}
</div>

{# KPIs #}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
  <div class="card">
    <div class="lbl">المستخدمون (الإجمالي)</div>
    <div class="kpi">{{ users_total|default:0|intcomma }}</div>
    <div class="text-xs text-slate-500 mt-1">طاقم: {{ users_staff|default:0|intcomma }}</div>
    {% if urls.users|default:users_list_url %}
      <div class="mt-3">
        <a href="{{ urls.users|default:users_list_url }}" class="btn btn-blue"><i class="fa fa-user-gear"></i><span>إدارة المستخدمين</span></a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div class="lbl">الطلبات (حسب الحالة)</div>
    <div class="kpi">{% if req_counts %}{{ req_counts|length|intcomma }}{% else %}0{% endif %}</div>
    <div class="mt-2 text-xs text-slate-500">
      {% if req_counts %}
        <ul class="space-y-1">
          {% for row in req_counts %}
            <li><span class="font-medium">{{ row.state|default:"غير محدد" }}</span> — {{ row.c|intcomma }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <span>لا توجد بيانات حالة</span>
      {% endif %}
    </div>
    {% if urls.requests|default:req_list_url %}
      <div class="mt-3">
        <a href="{{ urls.requests|default:req_list_url }}" class="btn btn-gray"><i class="fa fa-list"></i><span>عرض الطلبات</span></a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div class="lbl">الفواتير (إجمالي/مدفوعة/غير مدفوعة)</div>
    <div class="kpi">{{ inv_totals.total|default:0|intcomma }}</div>
    <div class="text-xs text-slate-500 mt-1">مدفوعة: {{ inv_totals.paid|default:0|intcomma }} — غير مدفوعة: {{ inv_totals.unpaid|default:0|intcomma }}</div>
    {% if urls.invoices|default:inv_list_url %}
      <div class="mt-3">
        <a href="{{ urls.invoices|default:inv_list_url }}" class="btn btn-green"><i class="fa fa-receipt"></i><span>إدارة الفواتير</span></a>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div class="lbl">العروض / الاتفاقيات</div>
    <div class="kpi">{{ agreements_total|default:0|intcomma }}</div>
    <div class="text-xs text-slate-500 mt-1">العروض: {{ offers_total|default:0|intcomma }}</div>
    <div class="mt-3 flex gap-2">
      {% if urls.agreements|default:agreements_list_url %}
        <a href="{{ urls.agreements|default:agreements_list_url }}" class="btn btn-purple"><i class="fa fa-file-signature"></i><span>الاتفاقيات</span></a>
      {% endif %}
      {% if urls.offers|default:offers_list_url %}
        <a href="{{ urls.offers|default:offers_list_url }}" class="btn btn-gray"><i class="fa fa-handshake"></i><span>العروض</span></a>
      {% endif %}
    </div>
  </div>
</div>

{# جداول مختصرة #}
<div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">آخر الطلبات</h2>
      {% if urls.requests|default:req_list_url %}
        <a href="{{ urls.requests|default:req_list_url }}" class="text-sm" style="color:var(--brand)">عرض الكل</a>
      {% endif %}
    </div>
    <div class="overflow-auto">
      <table class="table">
        <thead><tr><th>#</th><th>العنوان</th><th>العميل</th><th>الحالة</th></tr></thead>
        <tbody>
          {% for r in req_recent %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.title|default:"—" }}</td>
            <td>{% if r.client %}{{ r.client }}{% else %}—{% endif %}</td>
            <td>{{ r.state|default:"—" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">لا توجد طلبات حديثة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">آخر الفواتير</h2>
      {% if urls.invoices|default:inv_list_url %}
        <a href="{{ urls.invoices|default:inv_list_url }}" class="text-sm" style="color:var(--ok)">عرض الكل</a>
      {% endif %}
    </div>
    <div class="overflow-auto">
      <table class="table">
        <thead><tr><th>#</th><th>الاتفاقية</th><th>المبلغ</th><th>الحالة</th></tr></thead>
        <tbody>
          {% for inv in inv_recent %}
          <tr>
            <td>{{ inv.id }}</td>
            <td>{% if inv.agreement_id %}A{{ inv.agreement_id }}{% else %}—{% endif %}</td>
            <td>{{ inv.amount|default:0|intcomma }}</td>
            <td>{% if inv.is_paid %}مدفوعة{% else %}غير مدفوعة{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">لا توجد فواتير حديثة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">آخر الاتفاقيات</h2>
      {% if urls.agreements|default:agreements_list_url %}
        <a href="{{ urls.agreements|default:agreements_list_url }}" class="text-sm" style="color:var(--brand-2)">عرض الكل</a>
      {% endif %}
    </div>
    <div class="overflow-auto">
      <table class="table">
        <thead><tr><th>#</th><th>العنوان</th><th>الحالة</th></tr></thead>
        <tbody>
          {% for ag in agreements_recent %}
          <tr><td>{{ ag.id }}</td><td>{{ ag.title|default:"—" }}</td><td>{{ ag.status|default:"—" }}</td></tr>
          {% empty %}
          <tr><td colspan="3">لا توجد اتفاقيات حديثة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold">آخر النزاعات</h2>
      {% if urls.disputes|default:disputes_list_url %}
        <a href="{{ urls.disputes|default:disputes_list_url }}" class="text-sm" style="color:var(--danger)">عرض الكل</a>
      {% endif %}
    </div>
    <div class="overflow-auto">
      <table class="table">
        <thead><tr><th>#</th><th>الحالة</th><th>ملاحظة</th></tr></thead>
        <tbody>
          {% for d in disputes_recent %}
          <tr>
            <td>{{ d.id }}</td>
            <td>{{ d.status|default:"—" }}</td>
            <td>{% if d.title %}{{ d.title }}{% elif d.note %}{{ d.note|truncatechars:60 }}{% else %}—{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3">لا توجد نزاعات حديثة</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# تفصيل الأدوار #}
<div class="card mt-4">
  <div class="flex items-center justify-between mb-3">
    <h2 class="text-lg font-semibold">تفصيل أدوار المستخدمين</h2>
    <div class="flex gap-2">
      {% url 'dashboard:employees_list' as emp_url %}
      {% url 'dashboard:clients_list' as cli_url %}
      {% if emp_url %}<a href="{{ emp_url }}" class="btn btn-gray"><i class="fa fa-id-badge"></i><span>الموظفون</span></a>{% endif %}
      {% if cli_url %}<a href="{{ cli_url }}" class="btn btn-gray"><i class="fa fa-user"></i><span>العملاء</span></a>{% endif %}
    </div>
  </div>
  {% if role_counts %}
    <div class="overflow-auto">
      <table class="table">
        <thead><tr><th>الدور</th><th>العدد</th></tr></thead>
        <tbody>
          {% for row in role_counts %}
          <tr><td>{{ row.role|default:"—" }}</td><td>{{ row.c|intcomma }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="lbl">لا تتوفر حقول دور صريحة لعرضها.</p>
  {% endif %}
</div>
{% endblock %}
