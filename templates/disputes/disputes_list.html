{# disputes/templates/disputes/dispute_list.html (نزاعات الطلب) #}
{% extends "base.html" %}
{% block title %}نزاعات الطلب #{{ req.pk }}{% endblock %}

{% block extra_css %}
<style>
  .fade-in { animation: fadeIn .5s ease }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

  .card { transition: box-shadow .2s ease, transform .2s ease }
  .card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px -12px rgba(0,0,0,.15) }

  .chip { padding:.25rem .6rem; border-radius: .75rem; font-size: .72rem; border:1px solid rgba(148,163,184,.35) }
  .chip-open { background:#fef3c7; color:#92400e }
  .chip-review { background:#e0f2fe; color:#075985 }
  .chip-resolved { background:#dcfce7; color:#065f46 }
  .chip-canceled { background:#f8fafc; color:#475569 }

  .meta { font-size:.75rem; color:#64748b }
  .truncate-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
  .rtl .truncate-2 { text-overflow: ellipsis }

  .pill { border:1px solid rgba(148,163,184,.35); border-radius:9999px; padding:.35rem .8rem; font-size:.78rem }
  .pill-active { background:#111827; color:#fff }
  .dark .pill-active { background:#1f2937 }

  @media print {
    .print-hidden { display:none !important }
    .card { box-shadow:none !important; border:1px solid #e5e7eb }
  }
</style>
{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto rtl py-8 fade-in" dir="rtl">

  {# رأس الصفحة #}
  <div class="flex items-center justify-between mb-6 print-hidden">
    <div>
      <h1 class="text-2xl font-extrabold text-slate-900 dark:text-white">نزاعات الطلب #{{ req.pk }}</h1>
      <p class="meta mt-1">هنا ستجد كل النزاعات المفتوحة أو السابقة المتعلقة بهذا الطلب.</p>
    </div>
    <a class="btn btn-danger" href="{% url 'disputes:open_by_request' req.pk %}">فتح نزاع</a>
  </div>

  {# فلاتر بسيطة بالـ querystring: ?status=open/in_review/resolved/canceled #}
  <div class="flex flex-wrap gap-2 mb-6 print-hidden">
    {% with qs=request.GET.copy %}
      {% url 'disputes:list' req.pk as list_url %}
      <a href="{{ list_url }}" class="pill {% if not request.GET.status %}pill-active{% endif %}">الكل</a>
      {% with s='open' %}
        {% if qs.status %}{% endif %}<a href="{{ list_url }}?status={{ s }}" class="pill {% if request.GET.status == s %}pill-active{% endif %}">مفتوح</a>
      {% endwith %}
      {% with s='in_review' %}
        <a href="{{ list_url }}?status={{ s }}" class="pill {% if request.GET.status == s %}pill-active{% endif %}">قيد المراجعة</a>
      {% endwith %}
      {% with s='resolved' %}
        <a href="{{ list_url }}?status={{ s }}" class="pill {% if request.GET.status == s %}pill-active{% endif %}">محسوم</a>
      {% endwith %}
      {% with s='canceled' %}
        <a href="{{ list_url }}?status={{ s }}" class="pill {% if request.GET.status == s %}pill-active{% endif %}">ملغي</a>
      {% endwith %}
    {% endwith %}
  </div>

  {# قائمة النزاعات #}
  <div class="space-y-4">
    {% for d in disputes %}
      <article id="dispute-{{ d.pk }}" class="rounded-2xl border bg-white dark:bg-slate-800 p-5 card">

        {# رأس البطاقة: العنوان + الحالة #}
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="flex items-center gap-2 flex-wrap">
              <h2 class="font-bold text-slate-900 dark:text-white truncate" title="{{ d.title }}">{{ d.title|default:"— بدون عنوان —" }}</h2>
              {% if d.status == 'open' %}
                <span class="chip chip-open">مفتوح</span>
              {% elif d.status == 'in_review' %}
                <span class="chip chip-review">قيد المراجعة</span>
              {% elif d.status == 'resolved' %}
                <span class="chip chip-resolved">محسوم</span>
              {% elif d.status == 'canceled' %}
                <span class="chip chip-canceled">ملغي</span>
              {% else %}
                <span class="chip">{{ d.get_status_display|default:d.status }}</span>
              {% endif %}
              {% if d.is_frozen %}
                <span class="chip bg-rose-100 text-rose-700">مجمّد ماليًا</span>
              {% endif %}
              {% if d.milestone %}
                <span class="chip bg-indigo-50 text-indigo-700">مرحلة #{{ d.milestone.order|default:1 }}</span>
              {% endif %}
            </div>

            <div class="meta mt-1">
              فتح بواسطة: {{ d.opened_by|default:"—" }}
              — الدور: {{ d.opener_role|default:"—" }}
              — {{ d.opened_at|default:d.created_at|date:"Y-m-d H:i" }}
              {% if d.closed_at %} — إغلاق: {{ d.closed_at|date:"Y-m-d H:i" }}{% endif %}
            </div>
          </div>

          {# إجراءات سريعة للطباعة ونسخ الرقم #}
          <div class="print-hidden shrink-0 flex items-center gap-1">
            <button type="button" class="btn btn-ghost btn-sm" data-copy="{{ d.pk }}" aria-label="نسخ رقم النزاع">نسخ #</button>
            <button type="button" class="btn btn-ghost btn-sm" onclick="window.print()">طباعة</button>
          </div>
        </div>

        {# المحتوى المختصر مع إمكانية التوسيع #}
        <div class="mt-4 space-y-3">
          {% if d.reason %}
            <div class="text-sm">
              <b class="text-slate-700 dark:text-slate-300">السبب:</b>
              <span class="text-slate-800 dark:text-slate-200 block truncate-2" data-expand-target="reason-{{ d.pk }}">{{ d.reason }}</span>
            </div>
          {% endif %}
          {% if d.details %}
            <div class="text-sm">
              <b class="text-slate-700 dark:text-slate-300">التفاصيل:</b>
              <div class="text-slate-800 dark:text-slate-200 truncate-2 whitespace-pre-line" data-expand-target="details-{{ d.pk }}">{{ d.details }}</div>
            </div>
          {% endif %}
        </div>

        {# روابط عرض المزيد في حال النص طويل #}
        <div class="mt-2 print-hidden">
          {% if d.reason or d.details %}
            <button class="text-xs text-indigo-700 dark:text-indigo-300 hover:underline" data-expand-btn data-for="dispute-{{ d.pk }}">عرض المزيد</button>
          {% endif %}
        </div>

        {# أزرار الإدارة (محميّة فعليًا في الـ view) #}
        {% if request.user.is_staff or request.user.is_superuser or request.user.role == 'admin' or request.user.role == 'finance' %}
          <div class="mt-4 flex flex-wrap gap-2 print-hidden">
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button name="action" value="review" class="btn btn-secondary btn-sm">بدء مراجعة</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button name="action" value="resolve" class="btn btn-success btn-sm">حلّ النزاع</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button name="action" value="cancel" class="btn btn-outline btn-sm">إلغاء</button>
            </form>
            <form method="post" action="{% url 'disputes:update_status' d.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button name="action" value="reopen" class="btn btn-danger btn-sm">إعادة فتح</button>
            </form>
          </div>
        {% endif %}
      </article>
    {% empty %}
      <div class="rounded-2xl border bg-white dark:bg-slate-800 p-8 text-center">
        <p class="text-slate-500">لا توجد نزاعات لهذا الطلب.</p>
        <div class="mt-4 print-hidden">
          <a class="btn btn-danger" href="{% url 'disputes:open_by_request' req.pk %}">فتح أول نزاع</a>
        </div>
      </div>
    {% endfor %}
  </div>

  {# شريط أدوات سفلي للطباعة والرجوع #}
  <div class="print-hidden flex items-center justify-between mt-8">
    <a href="{{ req.get_absolute_url }}" class="btn btn-light">رجوع للطلب</a>
    <button onclick="window.print()" class="btn btn-success">طباعة الصفحة</button>
  </div>
</section>

<script>
  // نسخ إلى الحافظة
  document.querySelectorAll('[data-copy]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var val = btn.getAttribute('data-copy') || ''
      if(!val) return
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(String(val)).then(function(){ toast('تم النسخ ✓') })
      }else{
        try{
          var ta = document.createElement('textarea')
          ta.value = String(val)
          document.body.appendChild(ta)
          ta.select()
          document.execCommand('copy')
          ta.remove()
          toast('تم النسخ ✓')
        }catch(e){}
      }
    })
  })

  // توسعة/طي النصوص الطويلة
  document.querySelectorAll('[data-expand-btn]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var rootId = btn.getAttribute('data-for')
      var root = document.getElementById(rootId)
      if(!root) return
      root.querySelectorAll('[data-expand-target]').forEach(function(el){
        if(el.classList.contains('truncate-2')){
          el.classList.remove('truncate-2'); btn.textContent = 'طيّ المحتوى'
        }else{
          el.classList.add('truncate-2'); btn.textContent = 'عرض المزيد'
        }
      })
    })
  })

  function toast(msg){
    var t = document.createElement('div')
    t.textContent = msg || ''
    t.role = 'status'
    t.setAttribute('aria-live','polite')
    t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-1.5 rounded-xl shadow z-[60]'
    document.body.appendChild(t)
    setTimeout(function(){ t.remove() }, 1400)
  }
</script>
{% endblock %}
