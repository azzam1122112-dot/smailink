{# disputes/templates/disputes/dispute_open.html (أو الاسم الذي تستخدمه في urls) #}
{% extends "base.html" %}
{% block title %}فتح نزاع — طلب #{{ req.pk }}{% endblock %}

{% block extra_head %}
<style>
  /* صفحة فتح النزاع */
  .page-open-dispute {
    padding: 3rem 0 4rem;
  }

  .open-dispute-inner {
    max-width: 720px;
    margin: 0 auto;
  }

  .fade-in {
    animation: fadeIn .45s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .open-dispute-card {
    background: var(--white);
    border-radius: 1.4rem;
    border: 1px solid var(--dark-100);
    box-shadow: var(--shadow-md);
    padding: 1.8rem 1.6rem;
  }

  .open-dispute-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .open-dispute-title {
    font-size: 1.35rem;
    font-weight: 800;
    color: var(--dark-900);
  }

  .open-dispute-subtitle {
    font-size: 0.9rem;
    color: var(--dark-500);
    margin-top: 0.3rem;
  }

  .open-dispute-title span {
    color: var(--primary-700);
  }

  /* تنسيق الأخطاء العامة */
  .alert-danger {
    margin-bottom: 1.2rem;
    padding: 0.8rem 1rem;
    border-radius: 1rem;
    border: 1px solid #fecaca;
    background: #fef2f2;
    color: #991b1b;
    font-size: 0.85rem;
  }

  /* مجموعات الحقول */
  .field-group {
    margin-bottom: 1.4rem;
  }

  .field-label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--dark-700);
    margin-bottom: 0.3rem;
  }

  .field-hint {
    font-size: 0.78rem;
    color: var(--dark-500);
  }

  .field-input,
  .field-textarea,
  .field-select {
    width: 100%;
    border-radius: 0.9rem;
    border: 1px solid var(--dark-200);
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    outline: none;
    transition: var(--transition-fast);
    background: #fff;
  }

  .field-textarea {
    min-height: 120px;
    resize: vertical;
  }

  .field-input:focus,
  .field-textarea:focus,
  .field-select:focus {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, .16);
  }

  .field-error {
    margin-top: 0.25rem;
    font-size: 0.78rem;
    color: #b91c1c;
  }

  /* عدّاد الأحرف */
  .field-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.3rem;
  }

  .char-counter {
    font-size: 0.75rem;
    color: var(--dark-500);
  }

  /* منطقة الأزرار السفلية */
  .form-actions {
    margin-top: 1.8rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
  }

  .btn.is-disabled {
    opacity: .6;
    pointer-events: none;
  }

  @media (max-width: 640px) {
    .open-dispute-card {
      padding: 1.4rem 1.1rem;
    }

    .open-dispute-header {
      flex-direction: column-reverse;
      align-items: flex-start;
    }

    .open-dispute-title {
      font-size: 1.2rem;
    }
  }

  /* المودال */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    display: none;
    z-index: 60;
  }

  .modal-backdrop.is-visible {
    display: block;
  }

  .modal-box {
    background: #fff;
    border-radius: 1.2rem;
    max-width: 420px;
    margin: 6rem auto 0;
    padding: 1.5rem 1.4rem 1.3rem;
    box-shadow: 0 18px 40px rgba(15, 23, 42, .28);
  }

  .modal-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--dark-900);
    margin-bottom: 0.4rem;
  }

  .modal-text {
    font-size: 0.88rem;
    color: var(--dark-600);
  }

  .modal-actions {
    margin-top: 1.2rem;
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
  }
</style>
{% endblock %}

{% block content %}
<section class="page-open-dispute" dir="rtl">
  <div class="container open-dispute-inner">
    <div class="open-dispute-card fade-in">

      {# رأس الصفحة #}
      <header class="open-dispute-header">
        <div>
          <h1 class="open-dispute-title">
            فتح نزاع للطلب <span>#{{ req.pk }}</span>
          </h1>
          <p class="open-dispute-subtitle">
            سيتم إشعار قسم النزاعات وإيقاف أي صرف مالي تلقائي حتى تتم مراجعة النزاع.
          </p>
        </div>
        <a href="{% url 'marketplace:request_detail' req.pk %}" class="btn btn-light">
          رجوع إلى الطلب
        </a>
      </header>

      {# أخطاء عامة للنموذج #}
      {% if form.non_field_errors %}
        <div class="alert-danger">
          {% for err in form.non_field_errors %}
            <div>{{ err }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form id="open-dispute-form"
            method="post"
            action="{% url 'disputes:open_by_request' req.pk %}"
            novalidate>
        {% csrf_token %}
        {{ form.media }}

        {# العنوان #}
        <div class="field-group">
          <label for="{{ form.title.id_for_label }}" class="field-label">
            العنوان
          </label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="field-error">
              {% for e in form.title.errors %}
                {{ e }}{% if not forloop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <div class="field-footer">
            <span class="field-hint">
              اكتب وصفًا مختصرًا وواضحًا لموضوع النزاع.
            </span>
            <span class="char-counter" data-counter-for="id_title"></span>
          </div>
        </div>

        {# السبب #}
        <div class="field-group">
          <label for="{{ form.reason.id_for_label }}" class="field-label">
            السبب
          </label>
          {{ form.reason }}
          {% if form.reason.errors %}
            <div class="field-error">
              {% for e in form.reason.errors %}
                {{ e }}{% if not forloop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <div class="field-footer">
            <span class="field-hint">
              اختر أو اكتب سببًا محددًا يُسهّل على الفريق معالجة النزاع.
            </span>
            <span class="char-counter" data-counter-for="id_reason"></span>
          </div>
        </div>

        {# التفاصيل الإضافية #}
        <div class="field-group">
          <label for="{{ form.details.id_for_label }}" class="field-label">
            تفاصيل إضافية
          </label>
          {{ form.details }}
          {% if form.details.errors %}
            <div class="field-error">
              {% for e in form.details.errors %}
                {{ e }}{% if not forloop.last %}<br>{% endif %}
              {% endfor %}
            </div>
          {% endif %}
          <div class="field-footer">
            <span class="field-hint">
              أدرج وقائع مختصرة وأدلّة (أرقام فواتير، مراحل، تواريخ… إلخ).
            </span>
            <span class="char-counter" data-counter-for="id_details"></span>
          </div>
        </div>

        {# ربط النزاع بمرحلة معينة (اختياري) #}
        {% if request.GET.milestone_id %}
          <input type="hidden" name="milestone_id" value="{{ request.GET.milestone_id }}">
        {% endif %}

        <div class="form-actions">
          <button id="submit-btn" type="button" class="btn btn-danger">
            فتح النزاع
          </button>
          <a href="{% url 'marketplace:request_detail' req.pk %}" class="btn btn-ghost">
            إلغاء والرجوع
          </a>
        </div>
      </form>
    </div>
  </div>
</section>

{# نافذة تأكيد بسيطة #}
<div id="confirm-backdrop" class="modal-backdrop">
  <div class="modal-box" role="dialog" aria-modal="true">
    <h3 class="modal-title">تأكيد فتح النزاع</h3>
    <p class="modal-text">
      سيتم فتح نزاع لهذا الطلب وإيقاف أي صرف مالي حتى تتم المراجعة.
      هل تريد المتابعة؟
    </p>
    <div class="modal-actions">
      <button id="cancel-confirm" type="button" class="btn btn-light">
        تراجع
      </button>
      <button id="confirm-submit" type="button" class="btn btn-danger">
        تأكيد فتح النزاع
      </button>
    </div>
  </div>
</div>

<script>
(function () {
  var form = document.getElementById("open-dispute-form");
  var submitBtn = document.getElementById("submit-btn");
  var backdrop = document.getElementById("confirm-backdrop");
  var confirmBtn = document.getElementById("confirm-submit");
  var cancelBtn = document.getElementById("cancel-confirm");

  // إضافة كلاس تنسيق للحقول (حتى لو لم تُضبط من الفورم)
  ["id_title", "id_reason", "id_details"].forEach(function (id) {
    var el = document.getElementById(id);
    if (!el) return;
    var tag = el.tagName.toLowerCase();
    if (tag === "textarea") {
      el.classList.add("field-textarea");
    } else if (tag === "select") {
      el.classList.add("field-select");
    } else {
      el.classList.add("field-input");
    }
  });

  // عدّادات الأحرف
  function wireCounter(id) {
    var el = document.getElementById(id);
    var counter = document.querySelector('[data-counter-for="' + id + '"]');
    if (!el || !counter) return;

    var max = el.getAttribute("maxlength");
    function update() {
      var len = (el.value || "").length;
      if (max) {
        counter.textContent = len + " / " + max;
      } else {
        counter.textContent = len + " حرف";
      }
    }
    el.addEventListener("input", update);
    update();
  }

  ["id_title", "id_reason", "id_details"].forEach(wireCounter);

  function lockForm() {
    if (submitBtn) {
      submitBtn.classList.add("is-disabled");
      submitBtn.setAttribute("disabled", "disabled");
    }
  }

  function openModal() {
    if (backdrop) {
      backdrop.classList.add("is-visible");
    }
  }

  function closeModal() {
    if (backdrop) {
      backdrop.classList.remove("is-visible");
    }
  }

  if (submitBtn) {
    submitBtn.addEventListener("click", function () {
      openModal();
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener("click", function () {
      closeModal();
    });
  }

  if (backdrop) {
    backdrop.addEventListener("click", function (e) {
      if (e.target === backdrop) {
        closeModal();
      }
    });
  }

  if (confirmBtn) {
    confirmBtn.addEventListener("click", function () {
      // إنشاء زر submit مخفي حتى نضمن الإرسال
      var hiddenSubmit = document.createElement("button");
      hiddenSubmit.type = "submit";
      hiddenSubmit.style.display = "none";
      form.appendChild(hiddenSubmit);
      lockForm();
      form.submit();
    });
  }

  // تحسين تجربة لوحة المفاتيح داخل المودال
  document.addEventListener("keydown", function (e) {
    if (!backdrop) return;
    var visible = backdrop.classList.contains("is-visible");
    if (!visible) return;

    if (e.key === "Escape") {
      e.preventDefault();
      closeModal();
    }
    if (e.key === "Enter") {
      e.preventDefault();
      if (confirmBtn) {
        confirmBtn.click();
      }
    }
  });
})();
</script>
{% endblock %}
